<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bet Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --bg-main: #1f2125;
  --bg-panel: #26292e;
  --text-main: #e6e7ea;
  --text-muted: #9aa0a6;

  --row-h: 46px;
  --gap: 10px;

  --row-h-compact: 38px;
  --gap-compact: 6px;

  --w-match: 90px;
  --w-status: 46px;
  --w-score: 56px;
  --w-bet: 110px;
  --w-bet-compact: 90px;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: Inter, system-ui, sans-serif;
  background: var(--bg-main);
  color: var(--text-main);
}

/* ===== COMPACT MODE ===== */
body.compact {
  --row-h: var(--row-h-compact);
  --gap: var(--gap-compact);
  --w-bet: var(--w-bet-compact);
}

/* ===== APP ===== */
.app {
  height: 100vh;
  display: grid;
  grid-template-rows: auto 1fr auto;
}

/* ===== TOP BAR ===== */
.topbar {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  padding: 8px 12px;
}

.toggle {
  background: var(--bg-panel);
  border-radius: 8px;
  padding: 6px 10px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
}

/* ===== TABLE ===== */
.table-wrapper { overflow-y: auto; }
.bets-scroll { overflow-x: auto; }

.table {
  display: grid;
  gap: var(--gap);
  padding: 10px;
}

/* HEADERS */
.th {
  height: var(--row-h);
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-panel);
  font-weight: 700;
  font-size: 13px;
}

/* LEFT CELLS */
.match, .label {
  height: var(--row-h);
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-panel);
  font-size: 13px;
  color: var(--text-muted);
}

.match.center {
  color: var(--text-main);
  font-weight: 700;
}

/* BET PILLS */
.bet {
  height: var(--row-h);
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  font-weight: 700;
  font-size: 14px;
  color: #111;
}

/* REMOVE EMPTY BET CELLS */
.bet:empty { background: transparent !important; }

/* ===== GLOW ON CHANGE ===== */
.bet.changed {
  animation: glow 0.7s ease-out;
}

@keyframes glow {
  0%   { box-shadow: 0 0 0 rgba(255,255,255,0); }
  30%  { box-shadow: 0 0 10px rgba(255,255,255,0.45); }
  100% { box-shadow: 0 0 0 rgba(255,255,255,0); }
}

/* STICKY LEFT */
.sticky {
  position: sticky;
  left: 0;
  z-index: 10;
  background: var(--bg-panel);
}

.sticky.status { left: var(--w-match); }
.sticky.score { left: calc(var(--w-match) + var(--w-status)); }

.sticky::before {
  content: "";
  position: absolute;
  inset: 0;
  background: var(--bg-panel);
  z-index: -1;
}

/* DIVIDER */
.divider {
  grid-column: 1 / -1;
  height: 1px;
  background: #3a3d42;
  margin: 6px 0;
}

/* ===== SUMMARY (ANIMATED) ===== */
.summary {
  background: var(--bg-panel);
  border-top: 1px solid #3a3d42;
  overflow: hidden;
  transition: max-height 0.3s ease, opacity 0.3s ease;
  max-height: 300px;
  opacity: 1;
}

.summary.hidden {
  max-height: 0;
  opacity: 0;
}

.summary-content { padding: 10px; }

.summary-row {
  display: grid;
  grid-template-columns: 120px auto;
  gap: 8px;
  align-items: center;
  margin-bottom: 6px;
}

.sum-label {
  font-weight: 700;
  font-size: 13px;
  color: var(--text-muted);
}

.sum-values {
  display: flex;
  gap: 6px;
}

.sum-cell {
  height: 32px;
  min-width: 90px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 13px;
  color: #111;
}
</style>
</head>

<body>

<div class="app">

  <div class="topbar">
    <div class="toggle" id="compactToggle">Compact / Normal</div>
    <div class="toggle" id="summaryToggle">Summary</div>
  </div>

  <div class="table-wrapper">
    <div class="bets-scroll">
      <div id="table" class="table"></div>
    </div>
  </div>

  <footer class="summary" id="summary">
    <div class="summary-content" id="summaryContent"></div>
  </footer>

</div>

<script>
const API_URL =
"https://script.google.com/macros/s/AKfycbyq9CTFOgnGo5Jp2hJ_MUqZhjWb0x99NfckqDV_nfZrO7dCvVlmrIek7LWtuXspjaE/exec";

const formatGBP = v => "£" + Number(v).toFixed(2);
const formatEUR = v => "€ " + Number(v).toFixed(2);

const summaryEl = document.getElementById("summary");
const snapshotKey = "betDashboardSnapshot";

/* ===== INITIAL STATE ===== */
function applyInitialState() {
  const isMobile = window.innerWidth <= 720;
  const isLandscape = window.matchMedia("(orientation: landscape)").matches;

  if (isMobile) {
    document.body.classList.add("compact");
    summaryEl.classList.toggle("hidden", isLandscape);
  }
}

applyInitialState();
window.addEventListener("orientationchange", () =>
  setTimeout(applyInitialState, 300)
);

document.getElementById("compactToggle").onclick =
  () => document.body.classList.toggle("compact");

document.getElementById("summaryToggle").onclick =
  () => summaryEl.classList.toggle("hidden");

/* ===== DATA + CHANGE DETECTION ===== */
fetch(API_URL).then(r => r.json()).then(data => {

  const table = document.getElementById("table");
  const summary = document.getElementById("summaryContent");

  const previous = JSON.parse(localStorage.getItem(snapshotKey) || "{}");
  const current = {};

  const markIfChanged = (el, key, value) => {
    if (previous[key] !== value) el.classList.add("changed");
    current[key] = value;
  };

  table.style.gridTemplateColumns =
    "var(--w-match) var(--w-status) var(--w-score) repeat(" +
    data.headers.length + ", var(--w-bet))";

  table.innerHTML += `
    <div class="th sticky">MATCH</div>
    <div class="th sticky status"></div>
    <div class="th sticky score"></div>
  `;

  data.headers.forEach(h =>
    table.innerHTML += `<div class="th">${h}</div>`
  );

  let rowIndex = 0;

  data.matches.forEach(m => {
    table.innerHTML += `
      <div class="match sticky">${m.match}</div>
      <div class="match center sticky status">${m.status}</div>
      <div class="match center sticky score">${m.score}</div>
    `;

    m.cells.forEach((c, i) => {
      if (!c.value) {
        table.innerHTML += `<div></div>`;
        return;
      }
      const el = document.createElement("div");
      el.className = "bet";
      el.style.background = c.color;
      el.textContent = c.value;

      const key = `m-${rowIndex}-${i}`;
      markIfChanged(el, key, c.value + "|" + c.color);

      table.appendChild(el);
    });

    rowIndex++;
  });

  table.innerHTML += `<div class="divider"></div>`;

  ["BET","WIN","WIN PP"].forEach((label,i)=>{
    table.innerHTML += `
      <div class="label sticky">${label}</div>
      <div class="sticky status"></div>
      <div class="sticky score"></div>
    `;

    data.betSummary[i].cells.forEach((c,j)=>{
      if (c.value === null) {
        table.innerHTML += `<div></div>`;
        return;
      }
      const el=document.createElement("div");
      el.className="bet";
      el.style.background=c.color;
      el.textContent=formatGBP(c.value);

      const key=`s-${i}-${j}`;
      markIfChanged(el,key,c.value+"|"+c.color);

      table.appendChild(el);
    });
  });

  data.totals.forEach(t=>{
    const row=document.createElement("div");
    row.className="summary-row";
    row.innerHTML=`<div class="sum-label">${t.label}</div>`;

    const vals=document.createElement("div");
    vals.className="sum-values";

    t.cells.slice(0,2).forEach((c,i)=>{
      const cell=document.createElement("div");
      cell.className="sum-cell";
      cell.style.background=c.color;
      cell.textContent=i===0?formatGBP(c.value??0):formatEUR(c.value??0);
      vals.appendChild(cell);
    });

    row.appendChild(vals);
    summary.appendChild(row);
  });

  localStorage.setItem(snapshotKey, JSON.stringify(current));
});
</script>

</body>
</html>
