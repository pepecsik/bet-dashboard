<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bet Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
:root{ --bg-main:#1c1f23; --bg-card:#262a30; --bg-soft:#2f343a; --bg-row:#343a40; --text-main:#ffffff; --accent-orange:#ff9f43; --row-h:50px; --gap:6px; --left-w:230px; --bet-w:80px; }
*{box-sizing:border-box}
body{ margin:0; font-family:Inter,sans-serif; background:var(--bg-main); color:var(--text-main); }
.app{ height:100vh; display:grid; grid-template-rows:1fr auto; }
@media (max-width:768px){ .app{ transform:scale(0.78); transform-origin:top left; width:128%; height:128%; } }
.main{ display:flex; gap:10px; padding:10px; overflow:hidden; }
.left-card{ width:var(--left-w); background:var(--bg-card); border-radius:14px; padding:8px; display:flex; flex-direction:column; gap:var(--gap); overflow-y:auto; scrollbar-width:none; }
.right-card{ flex:1; background:var(--bg-card); border-radius:14px; overflow-x:auto; overflow-y:auto; padding:8px; scrollbar-width:none; }
.rows{ display:flex; flex-direction:column; gap:var(--gap); min-width:max-content; }
.row{ display:flex; gap:var(--gap); }
.header-pill{ width:var(--bet-w); height:var(--row-h); background:var(--bg-soft); border-radius:10px; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:14px; font-weight:700; line-height:1.1; transition:all 0.5s ease; }
.header-pill small { font-size: 9px; opacity: 0.8; font-weight: 400; } /* For Debug Text */
.bet{ width:var(--bet-w); height:var(--row-h); border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:800; color:#111; }
.left-header{ height:var(--row-h); background:var(--bg-soft); border-radius:10px; display:flex; align-items:center; justify-content:center; position:relative; font-size:12px; font-weight:700; }
.left-divider, .right-divider{ height:8px; }
.left-row{ height:var(--row-h); display:grid; grid-template-columns:1fr 90px; gap:var(--gap); cursor:pointer; }
.left-cell{ background:var(--bg-soft); border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:600; }
.left-label{ height:var(--row-h); background:var(--bg-soft); border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; }
.pl-btn { position:absolute; left:10px; top:50%; transform:translateY(-50%); width:28px; height:28px; border-radius:50%; background:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; }
.pl-logo { width:90%; height:90%; object-fit:contain; }
.brand-btn { position:absolute; right:12px; top:50%; transform:translateY(-50%); width:34px; height:34px; }
.brand-logo { width:100%; height:100%; object-fit:cover; transform:scale(1.3); border-radius:8px; }
.team-logo{ width:38px; height:38px; object-fit:contain; }
.match-teams{ display:flex; gap:6px; align-items:center; }

/* SUMMARY & FOOTER */
.summary{ background:var(--bg-card); margin:0 10px 10px; border-radius:14px; overflow:hidden; border:1px solid #2f343a; }
.summary-toggle{ background:var(--bg-soft); padding:8px; text-align:center; cursor:pointer; }
.summary-toggle::before{ content:"‚ñº"; font-size:14px; }
.summary-content{ display:flex; flex-direction:column; gap:12px; padding:10px; }
.summary-content.hidden{ display:none; }
.summary-top-row{ display:flex; gap:12px; overflow-x:auto; }
.weekly-card{ flex:1.4; min-width:200px; background:var(--bg-soft); border-radius:14px; padding:12px; }
.ranking-card{ flex:1; min-width:200px; background:var(--bg-soft); border-radius:14px; padding:12px; cursor:pointer; }
.weekly-title, .ranking-title{ font-size:13px; font-weight:700; margin-bottom:8px; }
.week-row{ display:grid; grid-template-columns:90px 1fr 65px; background:var(--bg-row); padding:4px; margin-bottom:4px; border-radius:8px; font-size:11px; font-weight:700; }
.week-gbp{ text-align:right; padding-right:6px; } .week-gbp.green{ color:#7CFF5B; } .week-gbp.red{ color:#ff4d4d; }
.week-eur{ text-align:right; opacity:0.6; }
.rank-row{ display:grid; grid-template-columns:18px 1fr auto; gap:4px; background:var(--bg-row); padding:6px 8px; margin-bottom:6px; border-radius:10px; }
.rank-money{ color:#7CFF5B; font-weight:800; text-align:right; }
.rank-bets{ grid-column:2/4; font-size:10px; opacity:0.65; }
.history-card{ width:100%; background:var(--bg-soft); border-radius:14px; padding:14px; display:none; height:260px; }

/* OVERLAYS */
.big-win-overlay{ position:fixed; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index:2200; opacity:0; }
.big-win-text{ font-size:35vw; font-weight:900; color:#7CFF5B; text-shadow:0 0 40px rgba(0,0,0,0.9); transform:scale(0.5); }
.big-win-active{ animation:bigWinAnim 5s ease-out forwards; }
@keyframes bigWinAnim{ 0%{opacity:0;transform:scale(0.5)} 5%{opacity:1;transform:scale(1.1)} 10%{transform:scale(1)} 60%{opacity:1} 100%{opacity:0;transform:scale(1.4)} }

.modal-overlay{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:2100; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.3s; backdrop-filter:blur(4px); }
.modal-overlay.active{ opacity:1; pointer-events:all; }
.modal-card{ width:90%; max-width:400px; background:var(--bg-card); border-radius:16px; overflow:hidden; transform:translateY(20px); transition:transform 0.3s; max-height:85vh; display:flex; flex-direction:column; }
.modal-overlay.active .modal-card{ transform:translateY(0); }
.modal-header{ background:var(--bg-soft); padding:15px; text-align:center; position:relative; min-height:60px; display:flex; flex-direction:column; justify-content:center; }
.modal-back-btn{ position:absolute; left:12px; top:50%; transform:translateY(-50%); background:rgba(255,255,255,0.1); border:none; color:#fff; padding:6px 12px; border-radius:6px; font-weight:600; cursor:pointer; font-size:11px; }
.modal-header-logo{ position:absolute; right:12px; top:50%; transform:translateY(-50%); width:34px; height:34px; background:#fff; border-radius:50%; padding:4px; object-fit:contain; }
.modal-title{ font-weight:800; font-size:16px; } .modal-sub{ font-size:11px; color:var(--accent-orange); font-weight:700; text-transform:uppercase; }
.modal-tabs{ display:flex; background:var(--bg-row); }
.tab-btn{ flex:1; padding:12px; text-align:center; font-size:12px; font-weight:700; color:#9aa0a6; cursor:pointer; border-bottom:2px solid transparent; }
.tab-btn.active{ color:#fff; border-bottom-color:var(--accent-orange); background:rgba(255,255,255,0.03); }
.tab-content{ display:none; padding:15px; overflow-y:auto; } .tab-content.active{ display:block; }

.stat-row{ margin-bottom:12px; }
.stat-label{ display:flex; justify-content:space-between; font-size:11px; font-weight:700; margin-bottom:4px; }
.stat-bar-container{ display:flex; height:6px; gap:4px; background:#333; border-radius:3px; overflow:hidden; }
.sb-track{ flex:1; background:rgba(255,255,255,0.1); position:relative; }
.sb-fill{ height:100%; background:#999; position:absolute; }
.sb-track.home .sb-fill{ right:0; } .sb-track.away .sb-fill{ left:0; }
.sb-fill.orange{ background:var(--accent-orange); }

.tbl-grid{ display:grid; grid-template-columns:25px 1.5fr 44px 44px 44px 60px; align-items:center; gap:2px; }
.tbl-row{ padding:8px 15px; border-bottom:1px solid rgba(255,255,255,0.05); font-size:12px; font-weight:600; }
.tbl-header{ padding:10px 15px; font-size:10px; font-weight:700; color:#9aa0a6; background:var(--bg-row); }
.ta-c{ display:flex; justify-content:center; width:100%; text-align:center; }
.tbl-row .ta-c{ justify-content:flex-end; padding-right:8px; text-align:right; }
.tbl-team-wrap{ display:flex; align-items:center; gap:8px; } .tbl-logo{ width:20px; }
.txt-green{ color:#7CFF5B; } .form-dot{ width:6px; height:6px; border-radius:50%; background:#555; } .dot-W{ background:#7CFF5B; } .dot-L{ background:#ff4d4d; }

/* COLORS */
.status-green{ background:#7CFF5B!important; color:#1c1f23!important; border:1px solid #7CFF5B; }
.status-orange{ background:var(--accent-orange)!important; color:#1c1f23!important; box-shadow:0 0 15px rgba(255,159,67,0.6); }
.status-red{ background:#ff4d4d!important; color:#fff!important; opacity:0.8; border:1px solid #992222; }
</style>
</head>
<body>

<div class="app">
  <div class="main">
    <div class="left-card" id="left"></div>
    <div class="right-card"><div class="rows" id="right"></div></div>
  </div>
  <footer class="summary">
    <div class="summary-toggle open" id="summaryToggle"></div>
    <div class="summary-content" id="summaryContentWrap">
      <div class="summary-top-row">
        <div class="weekly-card" id="weeklyCard"></div>
        <div class="ranking-card" id="rankingCard">
          <div class="ranking-title">üèÜ All-Time Ranking</div>
          <div id="rankingBody"></div>
        </div>
      </div>
      <div class="history-card" id="historyCard">
        <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
          <span>üìà History</span>
          <div><button id="btnMatches" class="active">Matches</button><button id="btnMoney">Money</button></div>
        </div>
        <canvas id="historyChart" height="120"></canvas>
      </div>
    </div>
  </footer>
</div>

<div id="bigWinOverlay" class="big-win-overlay"><div id="bigWinText" class="big-win-text"></div></div>

<div class="modal-overlay" id="matchModal" onclick="closeModal('matchModal')">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div class="modal-header">
      <button class="modal-back-btn" onclick="closeModal('matchModal')">Back</button>
      <div class="modal-title" id="mTitle"></div><div class="modal-sub" id="mStatus"></div>
    </div>
    <div class="modal-tabs">
      <div class="tab-btn active" onclick="switchTab('stats', event)">Stats</div>
      <div class="tab-btn" onclick="switchTab('summary', event)">Summary</div>
    </div>
    <div id="tab-stats" class="tab-content active"></div>
    <div id="tab-summary" class="tab-content">
      <div class="event-item"><div class="event-icon">‚öΩ</div><div class="event-text" id="mScorers">-</div></div>
      <div class="event-item"><div class="event-icon">üü®</div><div class="event-text" id="mYellow">0 Yellow</div></div>
      <div class="event-item"><div class="event-icon">üü•</div><div class="event-text" id="mRed">0 Red</div></div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="tableModal" onclick="closeModal('tableModal')">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div class="modal-header">
      <button class="modal-back-btn" onclick="closeModal('tableModal')">Back</button>
      <div class="modal-title">Premier League</div><div class="modal-sub">Live Standings</div>
      <img src="https://media.api-sports.io/football/leagues/39.png" class="modal-header-logo">
    </div>
    <div class="tbl-header tbl-grid"><div class="ta-l">#</div><div class="ta-l">Team</div><div class="ta-c">MP</div><div class="ta-c">Pts</div><div class="ta-c">GD</div><div class="ta-r">Form</div></div>
    <div class="tab-content active" style="padding-top:0;"><div id="tableBody"></div></div>
  </div>
</div>

<script>
// REPLACE WITH YOUR URL
const API_URL="https://script.google.com/macros/s/AKfycbwyH6V8PAyglEdBCOyGgVRhrVLFVLhdr4deKPUznv8Rk2I9tz3plm4O0kfgfxkGdskwFw/exec";
const REFRESH_MS=30000;

const TEAM_LOGOS={
 ARS:"https://upload.wikimedia.org/wikipedia/en/thumb/5/53/Arsenal_FC.svg/200px-Arsenal_FC.svg.png",
 AVI:"https://1000logos.net/wp-content/uploads/2022/05/Aston-Villa-Logo.png",
 BOU:"https://upload.wikimedia.org/wikipedia/en/thumb/e/e5/AFC_Bournemouth_%282013%29.svg/200px-AFC_Bournemouth_%282013%29.svg.png",
 BRE:"https://upload.wikimedia.org/wikipedia/en/thumb/2/2a/Brentford_FC_crest.svg/200px-Brentford_FC_crest.svg.png",
 BRI:"https://upload.wikimedia.org/wikipedia/en/thumb/f/fd/Brighton_%26_Hove_Albion_logo.svg/200px-Brighton_%26_Hove_Albion_logo.svg.png",
 BUR:"https://upload.wikimedia.org/wikipedia/en/thumb/6/6d/Burnley_FC_Logo.svg/200px-Burnley_FC_Logo.svg.png",
 CHE:"https://upload.wikimedia.org/wikipedia/en/thumb/c/cc/Chelsea_FC.svg/200px-Chelsea_FC.svg.png",
 CPA:"https://upload.wikimedia.org/wikipedia/en/thumb/a/a2/Crystal_Palace_FC_logo_%282022%29.svg/200px-Crystal_Palace_FC_logo_%282022%29.svg.png",
 EVE:"https://upload.wikimedia.org/wikipedia/en/thumb/7/7c/Everton_FC_logo.svg/200px-Everton_FC_logo.svg.png",
 FUL:"https://upload.wikimedia.org/wikipedia/en/thumb/e/eb/Fulham_FC_%28shield%29.svg/200px-Fulham_FC_%28shield%29.svg.png",
 LEE:"https://upload.wikimedia.org/wikipedia/en/thumb/5/54/Leeds_United_F.C._logo.svg/200px-Leeds_United_F.C._logo.svg.png",
 LIV:"https://upload.wikimedia.org/wikipedia/en/thumb/0/0c/Liverpool_FC.svg/200px-Liverpool_FC.svg.png",
 CTY:"https://upload.wikimedia.org/wikipedia/en/thumb/e/eb/Manchester_City_FC_badge.svg/200px-Manchester_City_FC_badge.svg.png",
 MAN:"https://upload.wikimedia.org/wikipedia/en/thumb/7/7a/Manchester_United_FC_crest.svg/200px-Manchester_United_FC_crest.svg.png",
 NWC:"https://upload.wikimedia.org/wikipedia/en/thumb/5/56/Newcastle_United_Logo.svg/200px-Newcastle_United_Logo.svg.png",
 NOT:"https://upload.wikimedia.org/wikipedia/en/thumb/dd/Nottingham_Forest_F.C._logo.svg/200px-Nottingham_Forest_F.C._logo.svg.png",
 SUN:"https://1000logos.net/wp-content/uploads/2020/09/Sunderland-logo.png",
 TOT:"https://upload.wikimedia.org/wikipedia/en/thumb/b/b4/Tottenham_Hotspur.svg/200px-Tottenham_Hotspur.svg.png",
 WHA:"https://upload.wikimedia.org/wikipedia/en/thumb/c/c2/West_Ham_United_FC_logo.svg/200px-West_Ham_United_FC_logo.svg.png",
 WOL:"https://upload.wikimedia.org/wikipedia/en/thumb/f/fc/Wolverhampton_Wanderers.svg/200px-Wolverhampton_Wanderers.svg.png"
};

function renderTeam(raw){
  if(!raw) return "";
  const code = raw.trim().toUpperCase().replace(/[^A-Z]/g,"");
  const logo = TEAM_LOGOS[code];
  if(!logo) return `<span class="team-fallback">${code}</span>`;
  let style = "";
  if (code === "TOT") { style = "background:white; border-radius:50%; padding:3px;"; }
  if (code === "SUN") { style = "transform: scale(1.35);"; }
  if (code === "AVI") { style = "transform: scale(1.65);"; }
  return `<img src="${logo}" alt="${code}" class="team-logo" style="${style}" onerror="this.outerHTML='<span class=team-fallback>${code}</span>'">`;
}

let chartDataCache=null, tableCache=null;

function loadData(){
  // Add timestamp to bust cache
  fetch(API_URL + "?t=" + new Date().getTime())
  .then(r => r.json())
  .then(data => {
    const left=document.getElementById("left");
    const right=document.getElementById("right");
    const weekly=document.getElementById("weeklyCard");
    const ranking=document.getElementById("rankingBody");

    left.innerHTML=""; right.innerHTML="";
    weekly.innerHTML='<div class="weekly-title">üìä Weekly Summary</div>';
    ranking.innerHTML="";

    if(data.chartData) chartDataCache = data.chartData;
    if(data.leagueTable) tableCache = data.leagueTable;

    // 1. LEFT HEADER
    const dateText = data.date ? data.date : "Live";
    const lh=document.createElement("div");
    lh.className="left-header"; 
    lh.innerHTML = `<div class="pl-btn" onclick="openTable()"><img src="https://media.api-sports.io/football/leagues/39.png" class="pl-logo"></div><div style="display:flex;flex-direction:column;align-items:center;justify-content:center;line-height:1.1;"><span>MATCHES</span><span style="font-size:10px;font-weight:400;color:var(--accent-orange);text-transform:uppercase;margin-top:4px;">${dateText}</span></div><div class="brand-btn"><img src="apple-touch-icon.png" class="brand-logo"></div>`;
    left.appendChild(lh);
    left.appendChild(document.createElement("div")).className="left-divider";

    // 2. SORTING LOGIC
    let indices = [];
    if(data.headers){
        indices = data.headers.map((_, i) => i);
        // Filter empty headers
        indices = indices.filter(i => data.headers[i] && data.headers[i].trim() !== "");
    }

    // A. Count Pills per Column
    const greenCounts = new Array(data.headers.length).fill(0);
    const orangeCounts = new Array(data.headers.length).fill(0);
    const betCounts = new Array(data.headers.length).fill(0);

    if(data.matches) {
        data.matches.forEach(m => {
            m.cells.forEach((cell, colIdx) => {
                if (cell && cell.value && cell.value.trim() !== "") {
                    betCounts[colIdx]++;
                }
                if (cell && cell.color) {
                    const c = cell.color.toLowerCase();
                    if (c === '#7cff5b' || c === '#00ff00') greenCounts[colIdx]++;
                    if (c === '#ff9f43' || c === 'orange') orangeCounts[colIdx]++;
                }
            });
        });
    }

    // MAIN SORT FUNCTION
    if (data.columnStats && data.columnStats.length > 0) {
      indices.sort((a, b) => {
        const statA = data.columnStats[a] || {};
        const statB = data.columnStats[b] || {};
        const hasBetsA = betCounts[a] >= 3;
        const hasBetsB = betCounts[b] >= 3;

        // 1. Valid Bets (Push empty/test cols to right)
        if (hasBetsA && !hasBetsB) return -1;
        if (!hasBetsA && hasBetsB) return 1;

        // 2. Status (ALIVE before DEAD)
        const isDeadA = statA.status === "DEAD" ? 1 : 0;
        const isDeadB = statB.status === "DEAD" ? 1 : 0;
        if (isDeadA !== isDeadB) return isDeadA - isDeadB;

        // 3. Pending Count (Lower is better)
        const pendingA = (statA.pending === "" || statA.pending === undefined) ? 99 : Number(statA.pending);
        const pendingB = (statB.pending === "" || statB.pending === undefined) ? 99 : Number(statB.pending);
        if (pendingA !== pendingB) return pendingA - pendingB;

        // 4. Green Pills (Higher is better)
        if (greenCounts[a] !== greenCounts[b]) return greenCounts[b] - greenCounts[a];

        // 5. Orange Pills (Higher is better)
        return orangeCounts[b] - orangeCounts[a];
      });
    }

    // 3. RENDER HEADERS
    const headerRow = document.createElement("div");
    headerRow.className = "row";
    let totalWinAmount = 0;

    indices.forEach(idx => {
        const p = document.createElement("div");
        p.className = "header-pill";
        const name = data.headers[idx];
        
        let pendingText = "";
        let statusClass = "";

        if (data.columnStats && betCounts[idx] >= 3) {
            const s = data.columnStats[idx];
            const pVal = Number(s.pending);
            
            // DEBUG: Show Pending Count in Header
            pendingText = `<small>(${pVal})</small>`;

            if (s.status === "DEAD") {
                statusClass = "status-red";
            } else if (pVal === 0) {
                statusClass = "status-green";
                if(data.betSummary && data.betSummary[1]) {
                    totalWinAmount += (data.betSummary[1].cells[idx].value || 0);
                }
                setTimeout(() => fireScreenBlaster(p), 500);
            } else if (pVal <= 2) {
                statusClass = "status-orange";
            }
        }
        
        p.innerHTML = `${name}<br>${pendingText}`;
        if(statusClass) p.classList.add(statusClass);
        headerRow.appendChild(p);
    });

    if(totalWinAmount > 0) showBigWin(formatGBP(totalWinAmount));
    right.appendChild(headerRow);
    right.appendChild(document.createElement("div")).className="right-divider";

    // 4. RENDER MATCHES
    data.matches.forEach((m) => {
      const lr=document.createElement("div");
      lr.className="left-row";
      lr.style.gridTemplateColumns = "1fr 90px"; 
      lr.style.cursor = "pointer";
      lr.onclick = () => openModal(m);

      const [home, away] = m.match.split("-").map(t => t.trim().toUpperCase());
      const isLive = m.status.includes("'") || ["HT","1H","2H","LIVE"].includes(m.status);
      const badgeColor = isLive ? "#7CFF5B" : "#9aa0a6"; 
      const displayScore = (m.score && m.score.trim().length > 0) ? m.score : "";

      lr.innerHTML = `<div class="left-cell match"><div class="match-teams">${renderTeam(home)}<span>-</span>${renderTeam(away)}</div></div><div class="left-cell" style="display:flex;justify-content:center;gap:6px;align-items:center;padding:0 2px;background:var(--bg-soft);"><span style="color:${badgeColor};background:${isLive?"rgba(124,255,91,0.15)":"transparent"};border:1px solid ${isLive?"#7CFF5B":"transparent"};padding:2px 4px;border-radius:5px;font-size:11px;font-weight:800;min-width:36px;text-align:center;">${m.status}</span><span style="color:#fff;font-size:12px;font-weight:700;">${displayScore}</span></div>`;
      left.appendChild(lr);

      const rr=document.createElement("div");
      rr.className="row";
      indices.forEach(idx => {
        const c = m.cells[idx]; 
        const el=document.createElement("div");
        el.className="bet";
        if(c && c.value){ el.textContent=c.value; el.style.background=c.color; }
        rr.appendChild(el);
      });
      right.appendChild(rr);
    });

    left.appendChild(document.createElement("div")).className="left-divider";
    right.appendChild(document.createElement("div")).className="right-divider";

    // 5. SUMMARY ROWS
    ["BET","WIN","WIN PP"].forEach((label, rowIndex)=>{
      const lab=document.createElement("div"); lab.className="left-label"; lab.textContent=label;
      left.appendChild(lab);
      const rr=document.createElement("div"); rr.className="row";
      indices.forEach(idx => {
         const c = data.betSummary[rowIndex].cells[idx];
         const el=document.createElement("div"); 
         el.className="bet";
         el.textContent=formatGBP(c.value); el.style.background=c.color;
         rr.appendChild(el);
      });
      right.appendChild(rr);
    });

    // 6. BOTTOM CARDS
    data.totals.forEach(t=>{
      const green=["TOTAL WIN","TOTAL WIN PP","AVG. WIN"].includes(t.label);
      weekly.innerHTML+=`<div class="week-row"><div class="week-label">${t.label}</div><div class="week-gbp ${green?'green':'red'}">${formatGBP(t.cells[0].value)}</div><div class="week-eur">${formatEUR(t.cells[1].value)}</div></div>`;
    });

    data.ranking.forEach((r,i)=>{
      const medals = ["ü•á", "ü•à", "ü•â"];
      ranking.innerHTML+=`<div class="rank-row"><div class="rank-pos" style="font-size:1.2em">${medals[i]||(i+1)}</div><div class="rank-name">${r.name}</div><div class="rank-money">${formatGBP(r.money)}</div><div class="rank-bets">${r.matchesRight} matches right</div></div>`;
    });
  })
  .catch(err => {
    console.error(err);
  });
}

function showBigWin(amountText) {
  const overlay = document.getElementById("bigWinOverlay");
  const text = document.getElementById("bigWinText");
  if (!overlay || !text || overlay.classList.contains('big-win-active')) return;
  text.textContent = amountText;
  overlay.classList.add("big-win-active");
  setTimeout(() => overlay.classList.remove("big-win-active"), 5000);
}

function fireScreenBlaster(element) {
  if(element.dataset.fired) return;
  element.dataset.fired = "true";
  var end = Date.now() + 2000;
  (function frame() {
    confetti({ particleCount: 4, angle: 60, spread: 55, origin: { x: 0, y: 0.6 }, colors: ['#7CFF5B', '#ffffff', '#FFD700'], zIndex: 2000, shapes: ['square', 'circle', 'star'], scalar: 1.2 });
    confetti({ particleCount: 4, angle: 120, spread: 55, origin: { x: 1, y: 0.6 }, colors: ['#7CFF5B', '#ffffff', '#FFD700'], zIndex: 2000, shapes: ['square', 'circle', 'star'], scalar: 1.2 });
    if (Date.now() < end) requestAnimationFrame(frame);
    else setTimeout(() => { element.dataset.fired = ""; }, 3000);
  }());
}

function switchTab(tab, e) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  e.target.classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
}

function openModal(m) {
  const [homeCode, awayCode] = m.match.split("-");
  document.getElementById("mTitle").innerHTML = `<div style="display:flex; align-items:center; justify-content:center; gap:15px;"><div style="transform:scale(1.3);">${renderTeam(homeCode)}</div><span style="font-size:12px; opacity:0.4; font-weight:400;">vs</span><div style="transform:scale(1.3);">${renderTeam(awayCode)}</div></div>`;
  document.getElementById("mStatus").textContent = m.status + "  ‚Ä¢  " + (m.score || "0-0");
  const s = m.stats || {};
  const statsList = [{ label: "Possession", h: s.h_poss||50, a: s.a_poss||50, isPct: true }, { label: "Shots on Target", h: s.h_shots||0, a: s.a_shots||0 }, { label: "Shots off Target", h: s.h_shotsOff||0, a: s.a_shotsOff||0 }, { label: "Corners", h: s.h_corners||0, a: s.a_corners||0 }];
  const container = document.getElementById("tab-stats");
  container.innerHTML = ""; 
  statsList.forEach(stat => {
    let total = stat.h + stat.a;
    let hPct = total === 0 ? 0 : (stat.h / total) * 100;
    let aPct = total === 0 ? 0 : (stat.a / total) * 100;
    if(stat.isPct && total > 100) { hPct = stat.h; aPct = stat.a; }
    const hText = stat.isPct ? stat.h + "%" : stat.h;
    const aText = stat.isPct ? stat.a + "%" : stat.a;
    container.innerHTML += `<div class="stat-row"><div class="stat-label"><span>${hText}</span><span class="stat-name">${stat.label}</span><span>${aText}</span></div><div class="stat-bar-container"><div class="sb-track home"><div class="sb-fill ${(stat.h>=stat.a && stat.h>0)?'orange':''}" style="width:${hPct}%"></div></div><div class="sb-track away"><div class="sb-fill ${(stat.a>=stat.h && stat.a>0)?'orange':''}" style="width:${aPct}%"></div></div></div></div>`;
  });
  document.getElementById("mScorers").innerHTML = s.scorers ? `<span style="color:#fff">${s.scorers}</span>` : `<span style="color:#9aa0a6">No Goals</span>`;
  document.getElementById("mYellow").textContent = (s.yellow||0) + " Yellow Cards";
  document.getElementById("mRed").textContent = (s.red||0) + " Red Cards";
  document.getElementById("matchModal").classList.add("active");
}

function openTable() {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  if(!tableCache || tableCache.length === 0) tbody.innerHTML = "<div style='text-align:center;padding:20px;color:#9aa0a6'>Loading Standings...</div>";
  else {
    tableCache.forEach(t => {
      let dots = (t.form||"").split('').map(c => `<span class="form-dot ${c==='W'?'dot-W':c==='L'?'dot-L':'dot-D'}"></span>`).join('');
      tbody.innerHTML += `<div class="tbl-row tbl-grid"><div class="ta-l" style="color:#9aa0a6">${t.rank}</div><div class="tbl-team-wrap"><img src="${t.logo}" class="tbl-logo"><span>${t.team}</span></div><div class="ta-c">${t.mp}</div><div class="ta-c txt-green">${t.pts}</div><div class="ta-c" style="color:#9aa0a6">${t.gd > 0 ? '+'+t.gd : t.gd}</div><div class="tbl-form-wrap">${dots}</div></div>`;
    });
  }
  document.getElementById("tableModal").classList.add("active");
}

function closeModal(id) { document.getElementById(id).classList.remove("active"); }

renderSkeletons();
loadData();
setInterval(loadData,REFRESH_MS);

// === UTILS ===
const formatGBP=v=>"¬£ "+Number(v||0).toFixed(2);
const formatEUR=v=>"‚Ç¨ "+Number(v||0).toFixed(2);

document.getElementById("rankingCard").onclick=()=>{
  const h=document.getElementById("historyCard");
  const open = h.style.display === "none" || !h.style.display;
  h.style.display = open ? "block" : "none";
  if(open) drawHistoryChart("matches");
};
document.getElementById("summaryToggle").onclick=()=>{
  document.getElementById("summaryContentWrap").classList.toggle("hidden");
  document.getElementById("summaryToggle").classList.toggle("open");
  document.getElementById("historyCard").style.display="none";
};

const btnMatches = document.getElementById("btnMatches");
const btnMoney = document.getElementById("btnMoney");
if(btnMatches && btnMoney){
  btnMatches.onclick = ()=>{ btnMatches.classList.add("active"); btnMoney.classList.remove("active"); drawHistoryChart("matches"); };
  btnMoney.onclick = ()=>{ btnMoney.classList.add("active"); btnMatches.classList.remove("active"); drawHistoryChart("money"); };
}

function drawHistoryChart(type){
  if(historyChart && historyChart._type === type) return;
  const canvas = document.getElementById("historyChart");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  if(historyChart) historyChart.destroy();
  const source = chartDataCache ? chartDataCache[type] : null;
  if(!source || !source.length) return;
  const labels = source.map(r => new Date(r.date).toLocaleDateString());
  const players = ["Snackbar","Timbo","Pepe"];
  const colors = { Snackbar:"#7CFF5B", Timbo:"#4DA3FF", Pepe:"#FF5BC4" };
  historyChart = new Chart(ctx, { type: "line", data: { labels, datasets: players.map(p => ({ label: p, data: source.map(r => r[p]), borderColor: colors[p], backgroundColor: colors[p], tension: 0.3, pointRadius: 5 })) }, options: { plugins: { datalabels: { formatter: (value, ctx) => { const data = ctx.dataset.data; const index = ctx.dataIndex; if (index === 0) return null; const diff = value - data[index-1]; return diff <= 0 ? null : `+${diff}`; }, color: ctx => ctx.dataset.borderColor, font: { weight: "bold", size: 10 }, align: "top", offset: 6 } } } });
  historyChart._type = type;
}
</script>
</body>
</html>
