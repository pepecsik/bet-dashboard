<!DOCTYPE html>
<html lang="en" data-theme="carbon">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
 
<link rel="manifest" href="/bet-dashboard/manifest.json">
<meta name="theme-color" content="#141619">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Juice Bets">

<link rel="apple-touch-icon" href="/apple-touch-icon.png">

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<title>Juice Bets</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=VT323&family=Quicksand:wght@600;700&display=swap" rel="stylesheet">

<style>
/* --- THEME: CARBON --- */
:root {
  --font-main: 'Inter', system-ui;
  --bg-grad: #141619; /* Simplified background */
  --bg-card: #21252b;
  --bg-soft: #2b3038;
  --text-main: #f3f4f6;
  --text-muted: #9ca3af;
  --accent-orange: #fb923c;
  --accent-green: #4ade80;
  --border-light: 1px solid rgba(255,255,255,0.1);
  --rad: 10px;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
body { margin: 0; font-family: var(--font-main); font-size: 12px; background: var(--bg-grad); color: var(--text-main); height: 100vh; overflow: hidden; }

/* --- LAYOUT --- */
.app { height: 100vh; display: grid; grid-template-rows: 1fr auto; }
.main { display: flex; gap: 8px; padding: 8px; overflow: hidden; position: relative; }

/* --- LEFT COLUMN (MATCHES) --- */
.left-card { 
    width: 220px; flex-shrink: 0; 
    background: var(--bg-card); border-radius: var(--rad); 
    display: flex; flex-direction: column; gap: 5px; 
    overflow-y: hidden; /* Scroll linked to right via JS */
    border: var(--border-light);
}

/* --- RIGHT COLUMN (BETS) --- */
.right-card { 
    flex: 1; 
    background: var(--bg-card); border-radius: var(--rad); 
    display: flex; flex-direction: column; 
    overflow: hidden; 
    border: var(--border-light);
}
.headers-area { display: flex; gap: 5px; padding: 8px; border-bottom: var(--border-light); background: var(--bg-soft); overflow-x: hidden; }
.scroll-area { overflow: auto; padding: 8px; flex: 1; scroll-behavior: smooth; }

/* --- ROW STYLES --- */
.match-row { 
    height: 50px; margin-bottom: 6px; 
    background: var(--bg-soft); border-radius: 8px; 
    display: flex; align-items: center; padding: 0 8px;
    border: 1px solid transparent;
}
.match-row.live { border-color: var(--accent-green); background: rgba(74, 222, 128, 0.05); }

.team-box { flex: 1; display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 11px; }
.vs-tag { opacity: 0.4; font-size: 9px; }
.score-box { width: 50px; text-align: center; font-weight: 800; font-size: 12px; }
.status-tag { font-size: 9px; padding: 2px 4px; border-radius: 4px; background: rgba(0,0,0,0.3); color: var(--text-muted); }

/* --- BET CELLS --- */
.bet-row { display: flex; gap: 5px; margin-bottom: 6px; height: 50px; }
.bet-cell { 
    width: 80px; flex-shrink: 0; height: 50px; 
    border-radius: 8px; 
    display: flex; align-items: center; justify-content: center; 
    font-weight: 800; font-size: 13px; color: #fff;
    background: rgba(255,255,255,0.03); /* Faint placeholder for everyone */
    border: 1px solid rgba(255,255,255,0.05);
    transition: all 0.2s;
}

/* --- STATES --- */
/* Your empty cell (Clickable) */
.bet-cell.my-empty { 
    border: 1.5px dashed var(--accent-orange) !important; 
    background: rgba(251, 146, 60, 0.05) !important;
    cursor: pointer;
}
/* Locked cell (Solid) */
.bet-cell.locked {
    border: 1.5px solid rgba(255,255,255,0.15) !important;
    opacity: 0.8;
    pointer-events: none;
}
/* Filled cell */
.bet-cell.filled {
    background: #2b3038; /* Fallback */
    border: 1px solid rgba(255,255,255,0.1);
}

/* --- HEADERS --- */
.header-cell { 
    width: 80px; flex-shrink: 0; height: 50px; 
    border-radius: 8px; background: var(--bg-card); 
    display: flex; align-items: center; justify-content: center; 
    position: relative; border: 1px solid rgba(255,255,255,0.1);
}
.avatar { width: 100%; height: 100%; object-fit: contain; transform: scale(1.2); filter: drop-shadow(0 4px 2px rgba(0,0,0,0.5)); }
.header-name { font-size: 10px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; }

/* --- MODALS --- */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
.modal-overlay.active { display: flex; }
.modal-card { width: 90%; max-width: 350px; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; text-align: center; }

.login-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0; }
.login-btn { 
    display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; 
    padding: 10px; border-radius: 10px; background: var(--bg-soft); border: 1px solid transparent; 
}
.login-btn:active { border-color: var(--accent-orange); transform: scale(0.95); }
.login-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: #000; }
.login-name { font-weight: 700; font-size: 11px; }

/* --- BET PICKER --- */
.picker-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 15px; }
.picker-btn { background: var(--bg-soft); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 12px 5px; border-radius: 8px; font-weight: 700; cursor: pointer; }
.picker-btn:active { background: var(--accent-orange); }
.clear-btn { grid-column: span 3; background: rgba(255,0,0,0.15); color: #ff6b6b; border-color: rgba(255,0,0,0.3); }

/* --- LOGO FALLBACK --- */
.logo-fallback { width: 30px; height: 30px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; color: #fff; border: 1px solid rgba(255,255,255,0.2); }

/* --- SUMMARY --- */
.summary { background: var(--bg-card); margin: 0 8px 8px; padding: 10px; border-radius: 12px; border: var(--border-light); height: 120px; overflow: hidden; }

/* LOADING */
#loading { position: fixed; top:0; left:0; width:100%; height:100%; background:#141619; z-index:3000; display:flex; align-items:center; justify-content:center; font-weight:800; letter-spacing:2px; }
</style>
</head>
<body>

<div id="loading">LOADING DATA...</div>

<div class="app">
  <div class="main">
    <div class="left-card" id="matchList"></div>

    <div class="right-card">
        <div class="headers-area" id="headersList"></div>
        <div class="scroll-area" id="betsList"></div>
    </div>
  </div>
  
  <footer class="summary" id="footerStats">
      <div style="font-size:10px; font-weight:700; color:#666; margin-bottom:5px;">WEEKLY LEADERBOARD</div>
      <div id="rankingList" style="display:flex; flex-direction:column; gap:4px;"></div>
  </footer>
</div>

<div id="loginModal" class="modal-overlay">
  <div class="modal-card">
    <h2>Who are you?</h2>
    <div class="login-grid" id="loginButtons"></div>
    <button class="picker-btn" style="width:100%; margin-top:10px; opacity:0.5;" onclick="login('Viewer')">Just Watching</button>
  </div>
</div>

<div id="pickerModal" class="modal-overlay">
  <div class="modal-card">
    <h3 id="pickerTitle" style="margin:0 0 15px 0;">Place Bet</h3>
    
    <div style="display:flex; gap:5px; margin-bottom:10px;">
        <button class="picker-btn" onclick="renderPicker('win')">1X2</button>
        <button class="picker-btn" onclick="renderPicker('score')">Score</button>
        <button class="picker-btn" onclick="renderPicker('goals')">Goals</button>
    </div>

    <div id="pickerGrid" class="picker-grid"></div>
  </div>
</div>

<script>
// --- CONFIGURATION ---
const API_URL = "https://script.google.com/macros/s/AKfycbwyH6V8PAyglEdBCOyGgVRhrVLFVLhdr4deKPUznv8Rk2I9tz3plm4O0kfgfxkGdskwFw/exec";
const AVATARS = {
    "SNACKBAR": "./snackbar.png",
    "TIMBO": "./timbo.png", // Mapped from TJALL if needed
    "TJALL": "./timbo.png",
    "PEPE": "./pepe.png",   // Mapped from PEPITO if needed
    "PEPITO": "./pepe.png"
};

// --- STATE ---
let rawData = null;
let currentUser = localStorage.getItem('jb_user');
let currentCtx = { row: null, col: null }; // Exact coordinates

// --- INITIALIZATION ---
window.onload = () => {
    fetchData();
    setInterval(fetchData, 30000);
    
    // Sync Scroll
    const left = document.getElementById('matchList');
    const right = document.getElementById('betsList');
    right.addEventListener('scroll', () => { left.scrollTop = right.scrollTop; });
};

// --- DATA FETCHING ---
async function fetchData() {
    try {
        const res = await fetch(API_URL);
        rawData = await res.json();
        
        document.getElementById('loading').style.display = 'none';
        
        if (!currentUser) {
            showLogin();
        } else {
            renderApp();
        }
    } catch (e) {
        console.error("Data Load Error:", e);
    }
}

// --- LOGIN LOGIC ---
function showLogin() {
    const container = document.getElementById('loginButtons');
    container.innerHTML = '';
    
    // Extract Unique Names from Headers
    const uniqueNames = [...new Set(rawData.headers.map(h => h.name.trim().toUpperCase()))];
    
    uniqueNames.forEach(name => {
        if(name === "INFO") return; // Skip info column if exists
        
        const div = document.createElement('div');
        div.className = 'login-btn';
        div.onclick = () => login(name);
        
        // Try to find avatar or use default
        const imgUrl = AVATARS[name] || `https://ui-avatars.com/api/?name=${name}&background=random`;
        
        div.innerHTML = `
            <img src="${imgUrl}" class="login-img">
            <span class="login-name">${name}</span>
        `;
        container.appendChild(div);
    });
    
    document.getElementById('loginModal').classList.add('active');
}

function login(name) {
    currentUser = name;
    localStorage.setItem('jb_user', name);
    document.getElementById('loginModal').classList.remove('active');
    renderApp();
}

// --- MAIN RENDER ---
function renderApp() {
    const leftPanel = document.getElementById('matchList');
    const headersList = document.getElementById('headersList');
    const betsList = document.getElementById('betsList');
    const rankingList = document.getElementById('rankingList');
    
    leftPanel.innerHTML = '';
    headersList.innerHTML = '';
    betsList.innerHTML = '';
    
    // 1. Render Headers
    rawData.headers.forEach(h => {
        const div = document.createElement('div');
        div.className = 'header-cell';
        const name = h.name.trim().toUpperCase();
        
        // Status indicator (border color)
        if(h.status === 'red' || h.status === 'locked' || h.color === 'red') {
            div.style.borderColor = '#ef4444';
        } else if (h.status === 'orange') {
            div.style.borderColor = 'var(--accent-orange)';
        }

        if(AVATARS[name]) {
            div.innerHTML = `<img src="${AVATARS[name]}" class="avatar">`;
            div.style.overflow = "visible";
        } else {
            div.innerHTML = `<span class="header-name">${name}</span>`;
        }
        headersList.appendChild(div);
    });
    
    // 2. Render Matches & Bets
    rawData.matches.forEach((m, rowIdx) => {
        // --- Left Side (Match Info) ---
        const [home, away] = m.match.split('-');
        const isLive = m.status.includes("'") || m.status === "HT";
        
        const leftRow = document.createElement('div');
        leftRow.className = `match-row ${isLive ? 'live' : ''}`;
        leftRow.innerHTML = `
            <div class="team-box">
                ${getLogo(home)} 
                <div style="display:flex; flex-direction:column; line-height:1;">
                    <span>${home}</span>
                    <span class="vs-tag">vs</span>
                    <span>${away}</span>
                </div>
            </div>
            <div class="score-box">
                <div style="color:${isLive ? 'var(--accent-green)' : 'inherit'}">${m.score || '-'}</div>
                <div class="status-tag">${m.status}</div>
            </div>
            ${getLogo(away)}
        `;
        leftPanel.appendChild(leftRow);
        
        // --- Right Side (Bets) ---
        const rightRow = document.createElement('div');
        rightRow.className = 'bet-row';
        
        m.cells.forEach((cell, colIdx) => {
            const betDiv = document.createElement('div');
            betDiv.className = 'bet-cell';
            betDiv.id = `cell-${rowIdx}-${colIdx}`; // For optimistic update
            
            const header = rawData.headers[colIdx];
            const headerName = header.name.trim().toUpperCase();
            const myName = currentUser ? currentUser.toUpperCase() : "";
            
            // Logic: Is this ME?
            const isMe = (headerName === myName);
            // Logic: Is this Locked? (Row 18 has price)
            const isLocked = (header.status === 'red' || header.status === 'locked' || header.color === 'red' || header.color === '#ff0000');

            if(cell.value) {
                // Has Bet
                betDiv.textContent = cell.value;
                betDiv.classList.add('filled');
                betDiv.style.backgroundColor = cell.color || '#262a30';
                
                if(isMe && !isLocked) {
                    betDiv.style.cursor = "pointer";
                    betDiv.onclick = () => openPicker(rowIdx, colIdx, m.match);
                } else if (isMe && isLocked) {
                    betDiv.classList.add('locked');
                }
            } else {
                // Empty
                if(isMe) {
                    if(!isLocked) {
                        betDiv.classList.add('my-empty'); // Orange Dash
                        betDiv.onclick = () => openPicker(rowIdx, colIdx, m.match);
                    } else {
                        betDiv.classList.add('locked'); // Solid border, no click
                    }
                }
                // Else: remains default faint border
            }
            
            rightRow.appendChild(betDiv);
        });
        betsList.appendChild(rightRow);
    });

    // 3. Render Ranking (Simple)
    if(rawData.ranking) {
        rankingList.innerHTML = rawData.ranking.map((r, i) => `
            <div style="display:flex; justify-content:space-between; font-size:11px; padding:2px 5px; background:rgba(255,255,255,0.05); border-radius:4px;">
                <span>#${i+1} ${r.name}</span>
                <span style="color:var(--accent-green); font-weight:800;">Â£${r.money}</span>
            </div>
        `).join('');
    }
}

// --- HELPERS ---
function getLogo(name) {
    if(!name) return '';
    const n = name.trim().toUpperCase();
    const map = {
        "ARS": "https://upload.wikimedia.org/wikipedia/en/5/53/Arsenal_FC.svg",
        "LIV": "https://upload.wikimedia.org/wikipedia/en/0/0c/Liverpool_FC.svg",
        "CTY": "https://upload.wikimedia.org/wikipedia/en/e/eb/Manchester_City_FC_badge.svg",
        // Add more known ones...
    };
    // Clean name for mapping
    const clean = n.substring(0, 3); 
    
    if(map[clean]) return `<img src="${map[clean]}" style="width:24px;">`;
    
    // Fallback Circle
    return `<div class="logo-fallback">${clean.substring(0,1)}</div>`;
}

// --- BETTING LOGIC ---
function openPicker(r, c, title) {
    if(navigator.vibrate) navigator.vibrate(10);
    currentCtx = { row: r, col: c };
    document.getElementById('pickerTitle').innerText = title;
    document.getElementById('pickerModal').classList.add('active');
    renderPicker('win'); // Default
}

function renderPicker(type) {
    const grid = document.getElementById('pickerGrid');
    grid.innerHTML = '';
    
    let opts = [];
    if(type === 'win') {
        const t = document.getElementById('pickerTitle').innerText.split('-');
        opts = [t[0].trim(), 'Draw', t[1].trim()];
    } else if (type === 'score') {
        opts = ['1-0','2-0','2-1','3-0','3-1','3-2','0-0','1-1','2-2','0-1','0-2','1-2','0-3','1-3','2-3'];
    } else {
        opts = ['Goals 0.5', 'Goals 1.5', 'Goals 2.5', 'BTTS', 'No BTTS'];
    }
    
    opts.forEach(val => {
        const btn = document.createElement('button');
        btn.className = 'picker-btn';
        btn.innerText = val;
        // Logic: if 'Draw', save 'X'. Else save value.
        let saveVal = val === 'Draw' ? 'X' : val;
        btn.onclick = () => saveBet(saveVal);
        grid.appendChild(btn);
    });

    // Add Clear Button
    const clear = document.createElement('button');
    clear.className = 'picker-btn clear-btn';
    clear.innerText = 'Clear Cell';
    clear.onclick = () => saveBet('');
    grid.appendChild(clear);
}

function saveBet(val) {
    document.getElementById('pickerModal').classList.remove('active');
    
    // Optimistic UI
    const el = document.getElementById(`cell-${currentCtx.row}-${currentCtx.col}`);
    if(el) {
        el.innerText = val;
        if(val) {
            el.className = 'bet-cell filled';
            el.style.background = '#262a30';
            confetti({ particleCount: 30, spread: 50, origin: { y: 0.6 }, scalar: 0.6 });
        } else {
            el.className = 'bet-cell my-empty';
            el.style.background = 'rgba(251, 146, 60, 0.05)';
        }
    }

    // Backend Logic: Calculate Relative Index
    // We need to tell the sheet: "This is Timbo's 2nd column" (Index 1)
    // First, find all columns that belong to current User
    const headerName = rawData.headers[currentCtx.col].name;
    const userCols = rawData.headers.map((h, i) => ({name: h.name, idx: i}))
                                    .filter(h => h.name === headerName);
    
    // Find where the clicked column ranks among the user's columns
    const relIdx = userCols.findIndex(item => item.idx === currentCtx.col);

    const payload = {
        user: currentUser, // "TJALL"
        row: currentCtx.row, // 0-based match index
        subCol: relIdx,      // 0 or 1 usually
        value: val
    };

    fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
    .then(r => r.json())
    .then(d => {
         if(d.status !== 'success') alert('Sync Error');
         else fetchData(); // Refresh real data
    });
}
</script>
</body>
</html>
