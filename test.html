<!DOCTYPE html>
<html lang="en" data-theme="carbon">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
 
<link rel="manifest" href="/bet-dashboard/manifest.json">
<meta name="theme-color" content="#141619">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Juice Bets">

<link rel="apple-touch-icon" href="/apple-touch-icon.png">

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<title>Juice Bets</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=VT323&family=Quicksand:wght@600;700&display=swap" rel="stylesheet">

<style>
/* =========================================
   THEME DEFINITIONS
   ========================================= */

/* 1. CARBON */
:root {
  --font-main: 'Inter', system-ui, sans-serif;
  --base-size: 12px;
  --bg-main: #141619;
  --bg-card: rgba(33, 37, 43, 0.95);
  --bg-soft: #2b3038;
  --bg-row:  #1f2329;
  --bg-modal: #1e293b; 
  --text-main: #f3f4f6;
  --text-muted: #9ca3af;
  --accent-orange: #fb923c;
  --accent-gold: #fbbf24;
  --accent-green: #4ade80;
  --border-light: 1px solid rgba(255, 255, 255, 0.08);
  --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
  --rad-sm: 6px;
  --rad-md: 10px;
  --rad-lg: 14px;
  --bg-grad: radial-gradient(circle at 50% 0%, #2b3038 0%, #141619 80%);
  --logo-filter: none;
  --modal-overlay: rgba(20, 22, 25, 0.85);
}

/* 2. CANDY */
[data-theme="candy"] {
  --font-main: 'Quicksand', sans-serif;
  --base-size: 13px;
  --bg-grad: linear-gradient(135deg, #ffdde1 0%, #ee9ca7 100%);
  --bg-card: rgba(255, 255, 255, 0.65); 
  --bg-soft: rgba(255, 255, 255, 0.85);
  --bg-row:  rgba(255, 255, 255, 0.5);
  --bg-modal: #fff0f5; 
  --text-main: #590d22; 
  --text-muted: #a4133c;
  --accent-orange: #ff9e00; 
  --accent-gold: #ffcc00;
  --accent-green: #2dc653; 
  --border-light: 1px solid rgba(255, 255, 255, 0.9);
  --shadow-card: 0 10px 30px -5px rgba(255, 20, 147, 0.15); 
  --rad-sm: 12px;
  --rad-md: 18px;
  --rad-lg: 26px;
  --logo-filter: drop-shadow(0 4px 6px rgba(255, 105, 180, 0.3));
  --modal-overlay: rgba(90, 10, 40, 0.4); 
}
[data-theme="candy"] .modal-header, [data-theme="candy"] .modal-scroll-area, [data-theme="candy"] .history-card-inner { background: var(--bg-soft) !important; }
[data-theme="candy"] .left-header { background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); }
[data-theme="candy"] .bet { box-shadow: 2px 4px 10px rgba(150, 50, 100, 0.05); border: 1px solid rgba(255,255,255,1); background: rgba(255,255,255,0.6); color: #590d22; }
[data-theme="candy"] .status-green { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%) !important; color: #064e3b !important; border-radius: 20px; }

/* 3. RETRO */
[data-theme="retro"] {
  --font-main: 'VT323', monospace; 
  --base-size: 16px;
  --bg-main: #000000;
  --bg-card: #000000;
  --bg-soft: #111111;
  --bg-row:  #1a1a1a;
  --bg-modal: #000000;
  --text-main: #00ff00; 
  --text-muted: #008f11;
  --accent-orange: #ff00ff;
  --accent-gold: #ffff00;
  --accent-green: #00ff00;
  --border-light: 2px solid #00ff00;
  --shadow-card: 4px 4px 0px #004400;
  --rad-sm: 0px; 
  --rad-md: 0px; 
  --rad-lg: 0px;
  --bg-grad: #000000;
  --logo-filter: none;
  --modal-overlay: rgba(0, 20, 0, 0.9);
}
[data-theme="retro"] .bet, [data-theme="retro"] .header-pill { text-transform: uppercase; letter-spacing: 1px; font-size: 20px; }
[data-theme="retro"] .status-green { animation: blink 0.5s infinite steps(1); box-shadow: none; border: 2px solid #00ff00 !important; background: #000 !important; color: #00ff00 !important; }
[data-theme="retro"] .left-cell, [data-theme="retro"] .week-label, [data-theme="retro"] .rank-name { font-size: 1.25em; }

/* =========================================
   CORE STYLES
   ========================================= */

:root{
  --row-h:50px; 
  --header-h:50px;
  --header-pill-w:70px;
  --gap:8px;
  --left-w:230px; 
  --bet-w:80px; 
  --summary-w:200px; 
  --week-row-h:30px;
  --filter-h: 40px; 
}

*{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
body{ margin:0; font-family: var(--font-main); font-size: var(--base-size); background: var(--bg-grad); color:var(--text-main); height: 100vh; overflow: hidden; letter-spacing: -0.02em; transition: background 0.5s ease, color 0.3s ease; }
.bet, .week-gbp, .rank-money, .ta-c, .stat-value-high { font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; }

/* Animations */
@keyframes rollIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
.animate-enter { animation: rollIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; }
@keyframes nervousPulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(251, 146, 60, 0.6); } 50% { transform: scale(1.08); box-shadow: 0 0 15px 5px rgba(251, 146, 60, 0.2); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(251, 146, 60, 0); } }
.status-orange { background-color: var(--accent-orange) !important; color: #0f172a !important; animation: nervousPulse 1.5s infinite ease-in-out !important; border: none !important; z-index: 10; }
@keyframes victoryShiver { 0% { transform: translate(0, 0) rotate(0deg); } 25% { transform: translate(-1px, 1px) rotate(-1deg); } 50% { transform: translate(1px, -1px) rotate(1deg); } 75% { transform: translate(-1px, -1px) rotate(-1deg); } 100% { transform: translate(0, 0) rotate(0deg); } }
.status-green, .status-green-live { background-color: var(--accent-green) !important; color: #000 !important; box-shadow: 0 0 20px rgba(74, 222, 128, 0.6); animation: victoryShiver 0.25s infinite linear !important; border: none !important; z-index: 12; }
.status-red { background-color: var(--bg-soft) !important; border: 1px solid #ef4444 !important; opacity: 1 !important; }
@keyframes sweatPulse { 0% { transform: scale(1); filter: brightness(1); } 50% { transform: scale(1.05); filter: brightness(1.3); } 100% { transform: scale(1); filter: brightness(1); } }
.sweat-active { animation: sweatPulse 1s ease-in-out infinite !important; z-index: 10; position: relative; border: 1px solid rgba(255,255,255,0.4) !important; box-shadow: 0 0 10px rgba(255,255,255,0.1); }
@keyframes goldPulse { 0% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); } 50% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); transform: scale(1.02); } 100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); } }
.gold-active { background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%) !important; animation: goldPulse 2s infinite !important; border: none !important; }
.gold-active span { color: #000 !important; text-shadow: none !important; }
.gold-active span:first-child { background: rgba(255,255,255,0.8) !important; color: #000 !important; }

/* Skeleton */
.skeleton { background-color: var(--bg-soft); animation: darkBreathing 1.5s infinite ease-in-out; color: transparent !important; border-radius: var(--rad-md); }
@keyframes darkBreathing { 0%, 100% { opacity: 0.5; } 50% { opacity: 0.8; } }
.sk-row { height: var(--row-h); margin-bottom: var(--gap); }

/* Layout */
.app{ height:100vh; display:grid; grid-template-rows: 1fr auto; }
@media (max-width: 768px){ 
  body { height: auto; overflow-y: auto; -webkit-overflow-scrolling: touch; } 
  .app { zoom: 0.78; display: flex; flex-direction: column; width: 100%; height: auto; min-height: 100vh; overflow: visible; } 
  .main { flex-direction: row; height: auto; overflow: visible; margin-bottom: 10px; } 
  .left-card, .right-card { max-height: none; overflow: visible; box-shadow: var(--shadow-card); border: var(--border-light); backdrop-filter: blur(10px); } 
  .summary { margin: 10px; box-shadow: var(--shadow-card); border: var(--border-light); backdrop-filter: blur(10px); position: relative; z-index: 10; } 
}
.main{ display:flex; gap:10px; padding:10px; overflow:hidden; position: relative; z-index: 5; }

/* Left Card */
.left-card{ width:var(--left-w); background:var(--bg-card); border-radius:var(--rad-lg); padding:8px; display:flex; flex-direction:column; gap:var(--gap); overflow-y:auto; max-height:100%; scrollbar-width:none; box-shadow: var(--shadow-card); border: var(--border-light); }
.left-card::-webkit-scrollbar { display: none; }
.left-header { height:var(--header-h); background: var(--bg-card); backdrop-filter: blur(10px); border-bottom: var(--border-light); border-radius:var(--rad-md); display:flex; align-items:center; justify-content:center; position: sticky; top: 0; z-index: 20; }
.header-title-box { display:flex; flex-direction:column; align-items:center; justify-content:center; line-height:1.2; gap: 6px; }
.header-main-text { font-size: 11px; font-weight: 800; letter-spacing: 0.5px; }
.header-sub-text { font-size: 9px; font-weight: 600; color: var(--accent-orange); text-transform: uppercase; }
.pl-btn { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 34px; height: 34px; border-radius: 50%; background: #ffffff; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer; }
.pl-btn:active { transform: translateY(-50%) scale(0.9); }
.pl-logo { width: 90%; height: 90%; object-fit: contain; transform: scale(0.9); }
.brand-btn { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: transparent; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.5); cursor: pointer; }
.brand-btn:active { transform: translateY(-50%) scale(0.9); }
.brand-logo { width: 100%; height: 100%; object-fit: cover; transform: scale(1.35); filter: var(--logo-filter); transition: filter 0.3s; }

/* Right Card */
.right-card{ flex:1; background:var(--bg-card); border-radius:var(--rad-lg); overflow-x:auto; overflow-y:auto; padding:8px; scrollbar-width:none; box-shadow: var(--shadow-card); border: var(--border-light); }
.right-card::-webkit-scrollbar { display: none; }
.rows{ display:flex; flex-direction:column; gap:var(--gap); min-width:max-content; }
.row{ display:flex; gap:var(--gap); }
.header-row-sticky { position: sticky; top: 0; z-index: 20; background: var(--bg-card); height: var(--header-h); display: flex; align-items: center; }
.header-pill-wrapper { width: var(--bet-w); height: 100%; display: flex; align-items: center; justify-content: center; }
.header-pill{ width:var(--header-pill-w); height:50px; background:var(--bg-soft); border-radius:var(--rad-md); display:flex; align-items:center; justify-content:center; font-size:16px; font-weight:800; transition: all 0.5s ease; }
.header-pill.has-avatar { padding: 0; overflow: visible; position: relative; }
.avatar-img { width: 100%; height: 100%; object-fit: contain; display: block; transform: scale(1.35); filter: drop-shadow(0 4px 5px rgba(0,0,0,0.4)); z-index: 5; }

/* BET PILLS */
.bet{ width:var(--bet-w); height:var(--row-h); border-radius: var(--rad-md); display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:800; color: #111; position: relative; background: var(--bet-bg); box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); }
.bet.empty { background: transparent; border: none; box-shadow: none; color: var(--text-muted); }

/* --- EDITABLE STATES --- */
/* YOUR EMPTY CELL: Orange Dashed Line */
.bet.my-empty { 
    border: 1.5px dashed var(--accent-orange) !important; 
    cursor: pointer !important;
    display: flex !important;
    visibility: visible !important;
    pointer-events: auto !important;
}
/* LOCKED CELL: Solid Border, No Click */
.bet.locked {
    border: 1.5px solid rgba(255,255,255,0.2) !important;
    cursor: default !important;
    display: flex !important;
    visibility: visible !important;
    pointer-events: none !important;
}

.col-hidden { display: none !important; }

/* Summary */
.summary { background: var(--bg-card); margin: 0 10px 10px 10px; border-radius: var(--rad-lg); overflow: hidden; box-shadow: var(--shadow-card); border: var(--border-light); position: relative; z-index: 10; }
.summary-toggle{ background:var(--bg-soft); padding:8px 12px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.summary-toggle::before{ content:"‚ñº"; font-size:14px; transition:transform .25s ease; }
.summary-toggle.open::before{ transform:rotate(180deg); }
.summary-content{ display:flex; flex-direction: column; gap:12px; padding:10px; transition:max-height .35s ease, opacity .25s ease; overflow:hidden; }
.summary-content.hidden{ max-height:0; opacity:0; padding-top:0; padding-bottom:0; }
.summary-top-row { display: flex; gap: 12px; width: 100%; overflow-x: auto; scrollbar-width: none; align-items: stretch; }
.summary-top-row::-webkit-scrollbar { display: none; }
.weekly-card { flex: 1.4; min-width:var(--summary-w); background:var(--bg-soft); border-radius:var(--rad-lg); padding:12px; }
.ranking-card{ flex: 1; min-width:var(--summary-w); background:var(--bg-soft); border-radius:var(--rad-lg); padding:12px; cursor:pointer; display: flex; flex-direction: column; transition: transform 0.1s; }
.ranking-card:active { transform: scale(0.96); background: rgba(255,255,255,0.1); }
#rankingBody { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
.weekly-title, .ranking-title{ font-size:13px; font-weight:700; margin-bottom:8px; }
.week-row{ height:var(--week-row-h); display:grid; grid-template-columns: 90px 1fr 65px; align-items:center; background:var(--bg-row); border-radius:var(--rad-sm); padding:0 4px; margin-bottom:4px; font-size:11px; font-weight:700; }
.week-label{ color:var(--text-main); white-space: nowrap; overflow: hidden; }
.week-gbp { text-align: right; padding-right: 6px; }
.week-eur { text-align: right; opacity:.6; }
.week-gbp.red{color:var(--text-main); opacity: 0.8;} 
[data-theme="carbon"] .week-gbp.red { color: #ef4444; opacity: 1; }
[data-theme="candy"] .week-gbp.red { color: #d00000; opacity: 1; }
[data-theme="retro"] .week-gbp.red { color: #ff0000; opacity: 1; }
.week-gbp.green{color:var(--accent-green);}
.rank-row{ display:grid; grid-template-columns:18px 1fr auto; grid-template-rows:auto auto; gap:2px 4px; background:var(--bg-row); border-radius:var(--rad-md); padding:6px 8px; margin-bottom:6px; }
.rank-pos{grid-row:span 2;font-weight:800; font-size: 1.1em;}
.rank-name{font-weight:600;font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.rank-money{font-weight:800;color:var(--accent-green); text-align:right;}
.rank-bets{grid-column:2/4;font-size:10px;opacity:.65; white-space:nowrap;}
.shame-row { background: linear-gradient(90deg, #3e2723 0%, var(--bg-row) 100%) !important; border: 1px solid #5d4037; opacity: 0.8; }
.shame-row .rank-pos { font-size: 1.4em; filter: grayscale(0); }
@keyframes firePulse { 0% { box-shadow: 0 0 0 0 rgba(251, 146, 60, 0.7); } 70% { box-shadow: 0 0 10px 10px rgba(251, 146, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(251, 146, 60, 0); } }
.on-fire { border: 1px solid var(--accent-orange) !important; animation: firePulse 2s infinite; position: relative; overflow: visible; }
.on-fire::after { content: "üî•"; position: absolute; top: -10px; right: -5px; font-size: 16px; z-index: 20; animation: nervousShiver 1s infinite; }

/* --- LOGIN MODAL STYLE --- */
.login-avatar-btn {
    width: 80px; height: 80px; border-radius: 12px;
    background: var(--bg-soft); border: 2px solid var(--border-light);
    cursor: pointer; transition: transform 0.2s, border-color 0.2s;
    object-fit: cover; display: flex; align-items: center; justify-content: center;
    font-size: 10px; font-weight: 800; flex-direction: column; gap: 5px;
    padding: 5px; color: #fff; text-transform: uppercase;
}
.login-avatar-btn img { width: 100%; height: 100%; object-fit: contain; border-radius: 8px; }
.login-avatar-btn:active { transform: scale(0.9); border-color: var(--accent-orange); }

/* --- BET PICKER --- */
.bet-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; padding: 5px; }
.bet-grid-scores { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 5px; align-items: start; }
.col-group { display: flex; flex-direction: column; gap: 8px; }
.bet-opt-btn { background: var(--bg-soft); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 15px 5px; border-radius: 10px; font-weight: 800; cursor: pointer; transition: transform 0.1s; font-family: var(--font-main); }
.bet-opt-btn:active { transform: scale(0.9); background: var(--accent-orange); }
.clear-btn { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); color: #ef4444; margin-top: 15px; width: 100%; }
.clear-btn:active { background: #ef4444; color: white; }

/* OTHER UI ELEMENTS */
.left-divider, .right-divider { height: 6px; flex-shrink: 0; }
.left-row{ height:var(--row-h); display:grid; grid-template-columns:1fr 90px; gap:var(--gap); cursor: pointer; transition: transform 0.08s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.1s; position: relative; z-index: 5; border-radius: 12px; }
.left-row:active { background-color: rgba(255, 255, 255, 0.15); transform: scale(0.96); }
.left-cell{ background:var(--bg-soft); border-radius:var(--rad-md); display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:600; pointer-events: none; flex-direction: column; }
.left-cell.match{text-align:center; flex-direction:row;}
.team-logo{ width:38px; height:38px; object-fit:contain; }
.team-fallback{ font-size:12px; font-weight:700; }
.match-teams{ display:flex; align-items:center; justify-content:center; gap:6px; }

/* Modals & Popups */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); z-index: 2100; backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
.modal-overlay.active { opacity: 1; pointer-events: all; }
.modal-card { width: 90%; max-width: 400px; background: var(--bg-modal); border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5); transform: translateY(20px); transition: transform 0.3s ease; display: flex; flex-direction: column; max-height: 85vh; border: var(--border-light); }
.modal-overlay.active .modal-card { transform: translateY(0); }
.modal-header { background: var(--bg-soft); padding: 20px 15px; text-align: center; position: relative; min-height: 80px; display: flex; flex-direction: column; justify-content: center; }
.modal-back-btn { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.1); border: none; color: var(--text-main); padding: 6px 12px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 11px; }
.modal-title { font-weight: 800; font-size: 16px; margin-bottom: 2px; color: var(--text-main); }
.modal-sub { font-size: 11px; color: var(--accent-orange); font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
.modal-tabs { display: flex; background: var(--bg-card); border-bottom: 1px solid rgba(255,255,255,0.1); }
.tab-btn { flex: 1; padding: 12px; text-align: center; font-size: 10px; font-weight: 700; color: var(--text-muted); cursor: pointer; background: transparent; border: none; border-bottom: 2px solid transparent; transition: all 0.2s; }
.tab-btn.active { color: var(--text-main); border-bottom: 2px solid var(--accent-orange); background: rgba(255,255,255,0.02); }
.modal-scroll-area { padding: 15px; overflow-y: auto; flex: 1; position:relative; background: var(--bg-modal); color: var(--text-main); }

</style>
</head>
<body>

<div class="app">
  <div class="main">
    <div class="left-card" id="left"></div>
    <div class="right-card"><div class="rows" id="right"></div></div>
  </div>

  <footer class="summary">
    <div class="summary-toggle open" id="summaryToggle"></div>
    <div class="summary-content" id="summaryContentWrap">
      <div class="summary-top-row">
        <div class="weekly-card" id="weeklyCard"></div>
        <div class="ranking-card" id="rankingCard">
          <div class="ranking-title">üèÜ All-Time Ranking</div>
          <div id="rankingBody"></div>
        </div>
      </div>
    </div>
  </footer>
</div>

<div id="loginOverlay" class="modal-overlay active" style="z-index: 5000;">
  <div class="modal-card" style="padding: 30px; text-align: center; max-width: 320px;">
    <div class="modal-title" style="font-size: 24px; margin-bottom: 20px;">Who are you?</div>
    <div id="loginContainer" style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;"></div>
    <button onclick="loginUser('Viewer')" class="filter-btn" style="margin-top: 25px; width: 100%; padding: 12px; opacity: 0.6; font-size: 12px;">I'm just watching</button>
  </div>
</div>

<div id="bigWinOverlay" class="big-win-overlay">
  <img id="bigWinAvatar" class="big-win-avatar" style="display:none;">
  <div id="bigWinText" class="big-win-text"></div>
</div>

<div id="betPickerModal" class="modal-overlay" onclick="closeModal('betPickerModal')">
  <div class="modal-card" onclick="event.stopPropagation()" style="max-height: 90vh;">
    <div class="modal-header">
      <button class="modal-back-btn" onclick="closeModal('betPickerModal')">Cancel</button>
      <div class="modal-title" id="bpMatchTitle">Place Bet</div>
      <div class="modal-sub" id="bpUserSub">Selection</div>
    </div>
    <div class="modal-tabs">
      <button class="tab-btn active" id="tabWin" onclick="switchBetTab('win')">WINNER</button>
      <button class="tab-btn" id="tabScore" onclick="switchBetTab('score')">SCORE</button>
      <button class="tab-btn" id="tabGoals" onclick="switchBetTab('goals')">GOALS+</button>
    </div>
    <div class="modal-scroll-area">
        <div id="gridWin" class="bet-grid"></div>
        <div id="gridScore" class="bet-grid-scores" style="display:none;"></div>
        <div id="gridGoals" class="bet-grid" style="display:none;"></div>
        <button class="bet-opt-btn clear-btn" onclick="submitBet('')">Empty / Clear Bet</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="matchModal" onclick="closeModal('matchModal')">
    <div class="modal-card" onclick="event.stopPropagation()">
      <div class="modal-header">
        <button class="modal-back-btn" onclick="closeModal('matchModal')">Back</button>
        <div class="modal-title" id="mTitle">MATCH</div>
        <div class="modal-sub" id="mStatus"></div>
      </div>
      <div class="modal-scroll-area" id="matchStatsContent"></div>
    </div>
</div>

<script>
// --- CONFIGURATION ---
const API_URL = "https://script.google.com/macros/s/AKfycbwyH6V8PAyglEdBCOyGgVRhrVLFVLhdr4deKPUznv8Rk2I9tz3plm4O0kfgfxkGdskwFw/exec";
const REFRESH_MS = 30000;
// Map known names to avatars. If name not here, it uses a generated initial
const AVATAR_MAP = {
    "SNACKBAR": "./snackbar.png",
    "TJALL": "./timbo.png",
    "TIMBO": "./timbo.png",
    "PEPITO": "./pepe.png",
    "PEPE": "./pepe.png"
};

// --- GLOBAL STATE ---
let currentUser = localStorage.getItem('jb_user') || null;
let currentBetContext = {};
let cachedData = null;

// --- INIT ---
if(currentUser) document.getElementById('loginOverlay').classList.remove('active');
loadData();
setInterval(loadData, REFRESH_MS);

// --- FUNCTIONS ---

function loginUser(name) {
    if(navigator.vibrate) navigator.vibrate(20);
    currentUser = name;
    localStorage.setItem('jb_user', name);
    document.getElementById('loginOverlay').classList.remove('active');
    loadData(); // Re-render with permissions
}

function loadData() {
    fetch(API_URL).then(r => r.json()).then(data => {
        cachedData = data;
        
        // 1. POPULATE LOGIN SCREEN (Once)
        if(document.getElementById('loginContainer').innerHTML === "") {
            populateLogin(data.headers);
        }

        renderApp(data);
    }).catch(e => console.error(e));
}

function populateLogin(headers) {
    const container = document.getElementById('loginContainer');
    const uniqueNames = [...new Set(headers.map(h => h.name.trim().toUpperCase()))];
    
    uniqueNames.forEach(name => {
        if(name === "INFO") return;
        const btn = document.createElement('div');
        btn.className = "login-avatar-btn";
        btn.onclick = () => loginUser(name);
        
        // Get Avatar or Fallback
        const imgUrl = AVATAR_MAP[name] || `https://ui-avatars.com/api/?name=${name}&background=random`;
        
        btn.innerHTML = `<img src="${imgUrl}"><span>${name}</span>`;
        container.appendChild(btn);
    });
}

function renderApp(data) {
    const left = document.getElementById("left");
    const right = document.getElementById("right");
    const weekly = document.getElementById("weeklyCard");
    const ranking = document.getElementById("rankingBody");

    left.innerHTML = ""; right.innerHTML = ""; weekly.innerHTML = ""; ranking.innerHTML = "";

    // --- CHECK GLOBAL LOCK ---
    // If all columns have price (status red/locked), we allow ranking sort. 
    // Otherwise, we force Sheet Order (Row 1, 2, 3...)
    const allLocked = data.headers.every(h => h.status === 'locked' || h.status === 'red' || h.color === 'red');
    
    // Sort Headers: Force Snackbar -> Tjall -> Pepito order if NOT locked
    if(!allLocked) {
        const priority = ['SNACKBAR', 'TJALL', 'PEPITO'];
        data.headers.sort((a,b) => {
            let ia = priority.findIndex(p => a.name.toUpperCase().includes(p));
            let ib = priority.findIndex(p => b.name.toUpperCase().includes(p));
            if(ia === -1) ia = 99; if(ib === -1) ib = 99;
            return ia - ib;
        });
    }

    // Sort Matches: Force Sheet Order (Original Index) if NOT locked
    // Assuming API sends matches in sheet order initially
    data.matches.forEach((m, i) => { if(m._id === undefined) m._id = i; }); // Tag ID
    let matches = [...data.matches];
    if(!allLocked) {
        matches.sort((a,b) => a._id - b._id);
    } 
    // Else leave them sorted by API (usually puts Live games top)

    // --- RENDER HEADERS ---
    const headerRow = document.createElement('div');
    headerRow.className = "row header-row-sticky";
    
    data.headers.forEach((h, i) => {
        const wrap = document.createElement('div');
        wrap.className = "header-pill-wrapper";
        
        const pill = document.createElement('div');
        pill.className = "header-pill";
        const name = h.name.trim().toUpperCase();
        
        if(AVATAR_MAP[name]) {
            pill.innerHTML = `<img src="${AVATAR_MAP[name]}" class="avatar-img">`;
            pill.classList.add('has-avatar');
        } else {
            pill.textContent = name.substring(0, 3);
        }
        
        // Header Status
        if(h.status === 'red' || h.status === 'locked' || h.color === 'red') pill.classList.add('status-red');
        else if(h.status === 'orange') pill.classList.add('status-orange');
        
        wrap.appendChild(pill);
        headerRow.appendChild(wrap);
    });
    right.appendChild(headerRow);
    right.appendChild(document.createElement('div')).className = "right-divider";

    // --- RENDER LEFT HEADER ---
    const lh = document.createElement("div"); lh.className = "left-header";
    lh.innerHTML = `<div class="header-title-box"><span class="header-main-text">MATCHDAY</span></div>`;
    left.appendChild(lh);
    left.appendChild(document.createElement('div')).className = "left-divider";

    // --- RENDER ROWS ---
    matches.forEach((m, rowIdx) => {
        const [home, away] = m.match.split('-').map(t => t.trim());
        
        // Left Side
        const lr = document.createElement('div');
        lr.className = "left-row";
        lr.style.gridTemplateColumns = "1fr 90px";
        lr.innerHTML = `
            <div class="left-cell match">
                 <div class="match-teams">
                    <div class="team-wrap-rel">${renderTeam(home)}</div>
                    <span>-</span>
                    <div class="team-wrap-rel">${renderTeam(away)}</div>
                 </div>
            </div>
            <div class="left-cell">
                 <span style="font-size:11px;font-weight:800;color:var(--text-muted)">${m.status}</span>
                 <span style="font-weight:700;">${m.score||""}</span>
            </div>
        `;
        // lr.onclick = () => openMatchStats(m); // Add this later if needed
        left.appendChild(lr);

        // Right Side
        const rr = document.createElement('div');
        rr.className = "row";
        
        data.headers.forEach((h, colIdx) => {
            // Find cell corresponding to this header
            // CAUTION: If we sorted headers, we need to map back to original cell index?
            // Assuming API cells are keyed or index matches sorted headers? 
            // SIMPLIFICATION: If API cells array matches original header array, and we sorted headers...
            // We need to use h._originalIndex if available.
            // Let's assume for now the API returns headers and cells in sync or we use the sorted index.
            // BETTER: Use Name matching if needed, but let's assume index alignment for now.
            const cell = m.cells[colIdx]; // This assumes strict alignment
            
            const el = document.createElement('div');
            el.className = "bet";
            el.id = `cell-${m._id}-${colIdx}`; // Unique ID for Optimistic UI

            const isMe = currentUser && h.name.toUpperCase() === currentUser.toUpperCase();
            const isLocked = h.status === 'red' || h.status === 'locked' || h.color === 'red' || h.color === '#ff0000';

            if(cell && cell.value) {
                el.textContent = cell.value;
                el.style.backgroundColor = cell.color || '#262a30';
                
                if(isMe && !isLocked) {
                    el.style.cursor = "pointer";
                    el.onclick = () => openBetPicker(m._id, colIdx, m.match);
                } else if(isMe && isLocked) {
                    el.classList.add('locked'); // Solid border
                }
            } else {
                // Empty
                el.classList.add('empty');
                if(isMe) {
                    if(!isLocked) {
                        el.classList.add('my-empty'); // Orange Dash
                        el.onclick = () => openBetPicker(m._id, colIdx, m.match);
                    } else {
                        el.classList.add('locked');
                    }
                }
                // Else: Faint border (default)
            }
            rr.appendChild(el);
        });
        right.appendChild(rr);
    });
    
    // --- SUMMARY ---
    // (Restoring simple summary rendering)
    if(data.totals) weekly.innerHTML = data.totals.map(t => `<div class="week-row"><span>${t.label}</span><span>${t.cells[1].value}</span></div>`).join('');
    if(data.ranking) ranking.innerHTML = data.ranking.map((r,i) => `<div class="rank-row">#${i+1} ${r.name} <span style="float:right">${r.money}</span></div>`).join('');
}

// --- BET LOGIC ---
function openBetPicker(rowId, colId, matchTitle) {
    if(navigator.vibrate) navigator.vibrate(10);
    currentBetContext = { row: rowId, col: colId };
    
    document.getElementById('bpMatchTitle').textContent = matchTitle;
    document.getElementById('betPickerModal').classList.add('active');
    
    // Default Tab
    switchBetTab('win');
}

function switchBetTab(tab) {
    const grid = document.getElementById('gridWin');
    const gridScore = document.getElementById('gridScore');
    const gridGoals = document.getElementById('gridGoals');
    
    grid.style.display = 'none'; gridScore.style.display = 'none'; gridGoals.style.display = 'none';
    
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('active');

    if(tab === 'win') {
        grid.style.display = 'grid';
        renderWinOptions();
    } else if (tab === 'score') {
        gridScore.style.display = 'grid';
        renderScoreOptions();
    } else {
        gridGoals.style.display = 'grid';
        renderGoalOptions();
    }
}

function renderWinOptions() {
    const grid = document.getElementById('gridWin');
    grid.innerHTML = '';
    const teams = document.getElementById('bpMatchTitle').textContent.split('-');
    [teams[0].trim(), 'Draw', teams[1].trim()].forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'bet-opt-btn';
        btn.innerHTML = `<span style="display:block;font-size:10px;opacity:0.6;">${i===1?'X':'Win'}</span>${opt}`;
        const val = i===1 ? 'X' : opt;
        btn.onclick = () => submitBet(val);
        grid.appendChild(btn);
    });
}

function renderScoreOptions() {
    const grid = document.getElementById('gridScore');
    grid.innerHTML = '';
    
    // 3 Columns: Home, Draw, Away
    const cols = [
        { title: 'HOME', vals: [] },
        { title: 'DRAW', vals: [] },
        { title: 'AWAY', vals: [] }
    ];
    
    // Fill logic
    for(let h=1; h<=6; h++) for(let a=0; a<h; a++) cols[0].vals.push(`${h}-${a}`);
    for(let i=0; i<=6; i++) cols[1].vals.push(`${i}-${i}`);
    for(let a=1; a<=6; a++) for(let h=0; h<a; h++) cols[2].vals.push(`${h}-${a}`);

    cols.forEach(c => {
        const div = document.createElement('div');
        div.className = 'col-group';
        div.innerHTML = `<div style="font-size:9px;color:#aaa;text-align:center;margin-bottom:5px;">${c.title}</div>`;
        c.vals.forEach(s => {
            const b = document.createElement('button');
            b.className = 'bet-opt-btn';
            b.textContent = s;
            b.style.marginBottom = '5px';
            b.onclick = () => submitBet(s);
            div.appendChild(b);
        });
        grid.appendChild(div);
    });
}

function renderGoalOptions() {
    const grid = document.getElementById('gridGoals');
    grid.innerHTML = '';
    ['Goals 0.5', 'Goals 1.5', 'Goals 2.5', 'Goals 3.5', 'U 1.5', 'U 2.5', 'BTTS', 'No BTTS'].forEach(o => {
        const btn = document.createElement('button');
        btn.className = 'bet-opt-btn';
        btn.textContent = o;
        btn.onclick = () => submitBet(o);
        grid.appendChild(btn);
    });
}

async function submitBet(val) {
    if(navigator.vibrate) navigator.vibrate(20);
    document.getElementById('betPickerModal').classList.remove('active');
    
    // 1. Optimistic UI Update
    const el = document.getElementById(`cell-${currentBetContext.row}-${currentBetContext.col}`);
    if(el) {
        if(val) {
            el.textContent = val;
            el.classList.remove('empty', 'my-empty');
            el.style.backgroundColor = '#262a30'; // Temp active color
            confetti({ particleCount: 30, spread: 60, origin: { y: 0.6 }, scalar: 0.6 });
        } else {
            el.textContent = '';
            el.classList.add('empty', 'my-empty');
            el.style.backgroundColor = 'transparent';
        }
    }

    // 2. Send to Backend (Relative Column Calculation)
    // We need to tell the sheet: "Update Timbo's 2nd column"
    const headerName = cachedData.headers[currentBetContext.col].name;
    const userCols = cachedData.headers.map((h, i) => ({name: h.name, idx: i}))
                                       .filter(h => h.name === headerName);
    const relIdx = userCols.findIndex(c => c.idx === currentBetContext.col);

    const payload = {
        user: currentUser, // "TJALL"
        row: currentBetContext.row, // 0-based index
        subCol: relIdx, // 0 or 1
        value: val
    };

    fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
    .then(r => r.json())
    .then(d => {
        if(d.status !== 'success') alert('Sync Error');
        else loadData(); // Refresh for final confirmation
    });
}

function renderTeam(name) {
    // Simple team renderer with fallback
    name = name.trim().toUpperCase();
    const map = TEAM_LOGOS || {};
    // Extract code from name (e.g. "ARSENAL" -> "ARS") or use map
    let code = name.substring(0,3);
    if(map[code]) return `<img src="${map[code]}" class="team-logo">`;
    return `<span style="font-weight:800;font-size:10px;">${code}</span>`;
}

function closeModal(id) { document.getElementById(id).classList.remove('active'); }
function toggleSummary() { document.getElementById('summaryContentWrap').classList.toggle('hidden'); }

</script>
</body>
</html>
