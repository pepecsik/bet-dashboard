<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#134d2b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Juice Bets">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<title>Juice Bets v6.1 Fixed</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
/* --- CORE CSS --- */
:root{ --bg-main:#1c1f23; --bg-card:#262a30; --bg-soft:#2f343a; --bg-row:#343a40; --text-main:#ffffff; --text-muted:#9aa0a6; --accent-orange: #ff9f43; --accent-green: #7CFF5B; --row-h:50px; --header-h:50px; --header-pill-w:70px; --gap:8px; --left-w:230px; --bet-w:80px; --summary-w:200px; --week-row-h:30px; --filter-h: 40px; --rad-sm: 6px; --rad-md: 10px; --rad-lg: 14px; }
*{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
body{ margin:0; font-family:Inter,system-ui,sans-serif; background: radial-gradient(circle at 50% 0%, #2f343a 0%, #1c1f23 80%); color:var(--text-main); height: 100vh; overflow: hidden; letter-spacing: -0.02em; }
.bet, .week-gbp, .rank-money, .ta-c, .stat-value-high { font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; }

/* LAYOUT */
.app{ height:100vh; display:grid; grid-template-rows: 1fr auto; }
@media (max-width: 768px){ body { height: auto; overflow-y: auto; } .app { zoom: 0.78; display: flex; flex-direction: column; width: 100%; height: auto; min-height: 100vh; overflow: visible; } .main { flex-direction: row; height: auto; overflow: visible; margin-bottom: 10px; } .left-card, .right-card { max-height: none; overflow: visible; box-shadow: 0 4px 20px rgba(0,0,0,0.4); border: 1px solid rgba(255, 255, 255, 0.08); } .summary { margin: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); border: 1px solid rgba(255, 255, 255, 0.08); position: relative; z-index: 10; } }
.main{ display:flex; gap:10px; padding:10px; overflow:hidden; position: relative; z-index: 5; }
.left-card{ width:var(--left-w); background:var(--bg-card); border-radius:var(--rad-lg); padding:8px; display:flex; flex-direction:column; gap:var(--gap); overflow-y:auto; max-height:100%; scrollbar-width:none; box-shadow: 0 4px 20px rgba(0,0,0,0.4); border: 1px solid rgba(255, 255, 255, 0.08); }
.left-card::-webkit-scrollbar { display: none; }
.left-header { height:var(--header-h); background: rgba(47, 52, 58, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.05); border-radius:var(--rad-md); display:flex; align-items:center; justify-content:center; position: sticky; top: 0; z-index: 20; }
.header-title-box { display:flex; flex-direction:column; align-items:center; justify-content:center; line-height:1.2; gap: 6px; }
.header-main-text { font-size: 11px; font-weight: 800; letter-spacing: 0.5px; }
.header-sub-text { font-size: 9px; font-weight: 600; color: var(--accent-orange); text-transform: uppercase; }
.pl-btn { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 34px; height: 34px; border-radius: 50%; background: #ffffff; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer; }
.pl-logo { width: 90%; height: 90%; object-fit: contain; transform: scale(0.9); }
.brand-btn { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: transparent; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
.brand-logo { width: 100%; height: 100%; object-fit: cover; transform: scale(1.3); }
.spacer-bar { display: flex; flex-direction: row; align-items: center; justify-content: space-between; height: var(--filter-h); padding: 0 4px; margin: 8px 0; box-sizing: border-box; }
.filter-title { font-size: 9px; font-weight: 800; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase; margin-right:auto; padding-left:4px; }
.filter-actions { display: flex; gap: 6px; }
.filter-btn { background: var(--bg-soft); border: 1px solid rgba(255,255,255,0.05); color: var(--text-muted); font-size: 10px; font-weight: 700; padding: 4px 10px; border-radius: var(--rad-sm); cursor: pointer; transition: all 0.2s; }
.filter-btn.active { background: #fff; color: #000; border-color: #fff; box-shadow: 0 2px 8px rgba(255,255,255,0.15); }
.left-divider, .right-divider { height: 6px; flex-shrink: 0; }
.left-row{ height:var(--row-h); display:grid; grid-template-columns:1fr 90px; gap:var(--gap); cursor: pointer; transition: transform 0.08s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.1s; position: relative; z-index: 5; border-radius: 12px; }
.left-row:active { background-color: rgba(255, 255, 255, 0.15); transform: scale(0.96); }
.left-cell{ background:var(--bg-soft); border-radius:var(--rad-md); display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:600; pointer-events: none; flex-direction: column; }
.left-cell.match{text-align:center; flex-direction:row;}
.match-teams{ display:flex; align-items:center; justify-content:center; gap:6px; }
.team-logo{ width:30px; height:30px; object-fit:contain; }
.team-rank-badge { position: absolute; top: -4px; left: -6px; font-size: 8px; font-weight: 800; color: #9aa0a6; background: rgba(0,0,0,0.6); padding: 1px 3px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); z-index: 12; }
.team-wrap-rel { position: relative; display: flex; align-items: center; justify-content: center; }

/* RIGHT CARD */
.right-card{ flex:1; background:var(--bg-card); border-radius:var(--rad-lg); overflow-x:auto; overflow-y:auto; padding:8px; scrollbar-width:none; box-shadow: 0 4px 20px rgba(0,0,0,0.4); border: 1px solid rgba(255, 255, 255, 0.08); }
.right-card::-webkit-scrollbar { display: none; }
.rows{ display:flex; flex-direction:column; gap:var(--gap); min-width:max-content; }
.row{ display:flex; gap:var(--gap); }
.header-row-sticky { position: sticky; top: 0; z-index: 20; background: var(--bg-card); height: var(--header-h); display: flex; align-items: center; }
.header-pill-wrapper { width: var(--bet-w); height: 100%; display: flex; align-items: center; justify-content: center; }
.header-pill{ width:var(--header-pill-w); height:50px; background:var(--bg-soft); border-radius:var(--rad-md); display:flex; align-items:center; justify-content:center; font-size:16px; font-weight:800; transition: all 0.5s ease; }
.header-pill.has-avatar { padding: 0; overflow: visible; position: relative; }
.avatar-img { width: 100%; height: 100%; object-fit: contain; display: block; transform: scale(1.35); filter: drop-shadow(0 4px 5px rgba(0,0,0,0.4)); z-index: 5; }
.bet{ width:var(--bet-w); height:var(--row-h); border-radius: var(--rad-md); display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:800; color:#111; position: relative; background: var(--bet-bg); box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); }
.bet.empty { background: transparent !important; border: none !important; box-shadow: none !important; }
.bet.editable-active { border: 2px dashed var(--accent-orange) !important; cursor: pointer; }
.bet.editable-active:active { transform: scale(0.9); background: rgba(255, 159, 67, 0.2) !important; }
.col-hidden { display: none !important; }

/* SUMMARY & MODALS */
.summary { background: var(--bg-card); margin: 0 10px 10px 10px; border-radius: var(--rad-lg); overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.4); border: 1px solid rgba(255, 255, 255, 0.08); position: relative; z-index: 10; }
.summary-toggle{ background:var(--bg-soft); padding:8px 12px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.summary-toggle::before{ content:"‚ñº"; font-size:14px; transition:transform .25s ease; }
.summary-toggle.open::before{ transform:rotate(180deg); }
.summary-content{ display:flex; flex-direction: column; gap:12px; padding:10px; transition:max-height .35s ease, opacity .25s ease; overflow:hidden; }
.summary-content.hidden{ max-height:0; opacity:0; padding-top:0; padding-bottom:0; }
.summary-top-row { display: flex; gap: 12px; width: 100%; overflow-x: auto; scrollbar-width: none; align-items: stretch; }
.weekly-card { flex: 1.4; min-width:var(--summary-w); background:var(--bg-soft); border-radius:var(--rad-lg); padding:12px; }
.ranking-card{ flex: 1; min-width:var(--summary-w); background:var(--bg-soft); border-radius:var(--rad-lg); padding:12px; cursor:pointer; display: flex; flex-direction: column; }
.rank-row{ display:grid; grid-template-columns:18px 1fr auto; gap:4px; background:var(--bg-row); border-radius:var(--rad-md); padding:6px 8px; margin-bottom:6px; }
.week-row{ height:var(--week-row-h); display:grid; grid-template-columns: 90px 1fr 65px; align-items:center; background:var(--bg-row); border-radius:var(--rad-sm); padding:0 4px; margin-bottom:4px; font-size:11px; font-weight:700; }
.week-gbp.green{color:#7CFF5B} .week-gbp.red{color:#ff4d4d}
.history-card-inner { width: 100%; background:var(--bg-soft); border-radius:var(--rad-lg); padding:12px; height: auto; min-height: 180px; }

/* ANIMATIONS */
@keyframes nervousPulse { 0% { transform: scale(1); } 50% { transform: scale(1.08); box-shadow: 0 0 15px var(--accent-orange); } 100% { transform: scale(1); } }
.status-orange { background-color: var(--accent-orange) !important; color: #000 !important; animation: nervousPulse 1.5s infinite ease-in-out !important; }
.status-green { background-color: var(--accent-green) !important; color: #000 !important; }
.status-red { background-color: #ff4d4d !important; color: #fff !important; opacity: 0.9; }

/* MODALS */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2100; backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
.modal-overlay.active { opacity: 1; pointer-events: all; }
.modal-card { width: 90%; max-width: 400px; background: var(--bg-card); border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5); transform: translateY(20px); transition: transform 0.3s ease; display: flex; flex-direction: column; max-height: 85vh; }
.modal-overlay.active .modal-card { transform: translateY(0); }
.modal-header { background: var(--bg-soft); padding: 20px 15px; text-align: center; position: relative; }
.modal-title { font-weight: 800; font-size: 16px; }
.modal-sub { font-size: 11px; color: var(--accent-orange); font-weight: 800; text-transform: uppercase; margin-top: 4px; }
.modal-scroll-area { padding: 15px; overflow-y: auto; flex: 1; }
.modal-tabs { display: flex; background: var(--bg-card); border-bottom: 1px solid rgba(255,255,255,0.1); }
.tab-btn { flex: 1; padding: 12px; text-align: center; font-size: 10px; font-weight: 700; color: var(--text-muted); cursor: pointer; background: transparent; border: none; border-bottom: 2px solid transparent; }
.tab-btn.active { color: #fff; border-bottom: 2px solid var(--accent-orange); background: rgba(255,255,255,0.02); }
.tbl-grid { display: grid; grid-template-columns: 25px 1.5fr 44px 44px 44px 60px; align-items: center; gap: 2px; }
.tbl-row { padding: 8px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 12px; font-weight: 600; }
.stat-row { margin-bottom: 12px; }
.stat-label { display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; margin-bottom: 4px; }
.stat-bar-container { display: flex; height: 6px; gap: 4px; overflow: hidden; }
.sb-half { flex: 1; background: rgba(255,255,255,0.1); border-radius: 3px; position: relative; overflow: hidden; }
.sb-fill { height: 100%; background: #999; transition: width 0.5s; position: absolute; }
.sb-half.home .sb-fill { right: 0; }
.sb-half.away .sb-fill { left: 0; }

/* LOGIN & BET INPUT */
.login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1c1f23; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
.login-grid { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; max-width: 400px; }
.login-item { display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; }
.login-avatar { width: 90px; height: 90px; border-radius: 50%; background: #2f343a; border: 4px solid transparent; padding: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transition: all 0.3s; object-fit: contain; }
.login-item:hover .login-avatar { border-color: var(--accent-orange); transform: translateY(-5px); }
.bet-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2500; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
.bet-card { background: var(--bg-card); padding: 25px; border-radius: 20px; width: 300px; display: flex; flex-direction: column; gap: 15px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); transform: translateY(20px); transition: transform 0.3s; }
.bet-modal.active .bet-card { transform: translateY(0); }
.opt-btn { background: var(--bg-soft); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 15px 0; border-radius: 12px; font-weight: 800; font-size: 18px; cursor: pointer; }
.score-in { background: #111; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 8px; width: 100%; text-align: center; font-size: 16px; font-weight: 700; }
.submit-bet-btn { background: var(--accent-green); color: #000; border: none; padding: 15px; border-radius: 12px; font-weight: 800; font-size: 14px; cursor: pointer; margin-top: 10px; width: 100%; }
.close-bet { position: absolute; top: 15px; right: 15px; color: #fff; cursor: pointer; font-size: 20px; opacity: 0.5; }
.logout-btn { background: #ff4d4d; border: none; padding: 4px 12px; border-radius: 12px; color: #fff; font-size: 10px; font-weight: 700; float: right; margin-bottom: 10px; cursor: pointer; }
</style>
</head>
<body>

<div id="loginOverlay" class="login-overlay">
  <div style="font-size:24px;font-weight:800;margin-bottom:40px;color:#fff;">Who are you?</div>
  <div class="login-grid">
    <div class="login-item" onclick="loginUser('Snackbar')">
      <img src="./snackbar.png" class="login-avatar">
      <div style="font-weight:700;font-size:14px;color:#9aa0a6;">Snackbar</div>
    </div>
    <div class="login-item" onclick="loginUser('Timbo')">
      <img src="./timbo.png" class="login-avatar">
      <div style="font-weight:700;font-size:14px;color:#9aa0a6;">Timbo</div>
    </div>
    <div class="login-item" onclick="loginUser('Pepe')">
      <img src="./pepe.png" class="login-avatar">
      <div style="font-weight:700;font-size:14px;color:#9aa0a6;">Pepe</div>
    </div>
  </div>
</div>

<div id="betModal" class="bet-modal">
  <div class="bet-card">
    <div class="close-bet" onclick="closeBetModal()">√ó</div>
    <div style="text-align:center;font-size:14px;font-weight:700;color:#fff;margin-bottom:10px;" id="bmTitle">MATCH TITLE</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
      <button class="opt-btn" onclick="setBetValue('1')">1</button>
      <button class="opt-btn" onclick="setBetValue('X')">X</button>
      <button class="opt-btn" onclick="setBetValue('2')">2</button>
    </div>
    <div style="display:flex;gap:10px;align-items:center;justify-content:center;margin-top:5px;">
      <input type="text" id="customBetInput" class="score-in" placeholder="Score (e.g. 2-1) or O1.5">
    </div>
    <button class="submit-bet-btn" onclick="submitCustomBet()">PLACE BET</button>
  </div>
</div>

<div class="app">
  <div class="main">
    <div class="left-card" id="left"></div>
    <div class="right-card"><div class="rows" id="right"></div></div>
  </div>

  <footer class="summary">
    <div class="summary-toggle open" id="summaryToggle"></div>
    <div class="summary-content" id="summaryContentWrap">
      <button class="logout-btn" onclick="logout()">LOGOUT</button>
      <div class="summary-top-row">
        <div class="weekly-card" id="weeklyCard"></div>
        <div class="ranking-card" id="rankingCard">
          <div class="ranking-title">üèÜ All-Time Ranking</div>
          <div id="rankingBody"></div>
        </div>
      </div>
      </div>
  </footer>
</div>

<div class="modal-overlay" id="matchModal" onclick="closeModal('matchModal')">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div class="modal-header">
      <button style="position:absolute;left:12px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;padding:6px 12px;border-radius:6px;font-weight:600;font-size:11px;" onclick="closeModal('matchModal')">Back</button>
      <div class="modal-title" id="mTitle">MATCH</div>
      <div class="modal-sub" id="mStatus">19:30</div>
    </div>
    <div class="modal-tabs">
      <button class="tab-btn active" id="tabStats" onclick="switchTab('stats')">STATS</button>
      <button class="tab-btn" id="tabLineups" onclick="switchTab('lineups')">LINEUPS</button>
      <button class="tab-btn" id="tabSummary" onclick="switchTab('summary')">SUMMARY</button>
    </div>
    <div class="modal-scroll-area">
       <div id="viewStats"><div id="statsArea"></div></div>
       <div id="viewLineups" style="display:none;"><div id="lineupsArea"></div></div>
       <div id="viewSummary" style="display:none;"><div id="summaryArea"></div></div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="tableModal" onclick="closeModal('tableModal')">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div class="modal-header">
      <button style="position:absolute;left:12px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;padding:6px 12px;border-radius:6px;font-weight:600;font-size:11px;" onclick="closeModal('tableModal')">Back</button>
      <div class="modal-title">Premier League</div>
      <img src="https://media.api-sports.io/football/leagues/39.png" style="position:absolute;right:15px;top:15px;width:32px;height:32px;background:#fff;border-radius:50%;padding:4px;">
    </div>
    <div class="tbl-header tbl-grid">
      <div class="ta-l">#</div><div class="ta-l">Team</div><div class="ta-c">MP</div><div class="ta-c">Pts</div><div class="ta-c">GD</div><div class="ta-r">Form</div>
    </div>
    <div class="modal-scroll-area" id="tableBody" style="padding-top:0;"></div>
  </div>
</div>

<div class="modal-overlay" id="historyModal" onclick="closeModal('historyModal')">
    <div class="modal-card" onclick="event.stopPropagation()">
      <div class="modal-header">
        <button style="position:absolute;left:12px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;padding:6px 12px;border-radius:6px;font-weight:600;font-size:11px;" onclick="closeModal('historyModal')">Back</button>
        <div class="modal-title">Performance History</div>
      </div>
      <div class="history-card-inner">
         <div style="position: relative; height: 180px; width: 100%;">
            <canvas id="historyChart"></canvas>
         </div>
      </div>
    </div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbwyH6V8PAyglEdBCOyGgVRhrVLFVLhdr4deKPUznv8Rk2I9tz3plm4O0kfgfxkGdskwFw/exec";
const AVATARS = { "Snackbar": "./snackbar.png", "Timbo": "./timbo.png", "Pepe": "./pepe.png" };
const TEAM_LOGOS = {
 ARS:"https://upload.wikimedia.org/wikipedia/en/thumb/5/53/Arsenal_FC.svg/200px-Arsenal_FC.svg.png",
 AVI:"https://1000logos.net/wp-content/uploads/2022/05/Aston-Villa-Logo.png",
 BOU:"https://upload.wikimedia.org/wikipedia/en/thumb/e/e5/AFC_Bournemouth_%282013%29.svg/200px-AFC_Bournemouth_%282013%29.svg.png",
 BRE:"https://upload.wikimedia.org/wikipedia/en/thumb/2/2a/Brentford_FC_crest.svg/200px-Brentford_FC_crest.svg.png",
 BRI:"https://upload.wikimedia.org/wikipedia/en/thumb/f/fd/Brighton_%26_Hove_Albion_logo.svg/200px-Brighton_%26_Hove_Albion_logo.svg.png",
 BUR:"https://upload.wikimedia.org/wikipedia/en/thumb/6/6d/Burnley_FC_Logo.svg/200px-Burnley_FC_Logo.svg.png",
 CHE:"https://upload.wikimedia.org/wikipedia/en/thumb/c/cc/Chelsea_FC.svg/200px-Chelsea_FC.svg.png",
 CPA:"https://upload.wikimedia.org/wikipedia/en/thumb/a/a2/Crystal_Palace_FC_logo_%282022%29.svg/200px-Crystal_Palace_FC_logo_%282022%29.svg.png",
 EVE:"https://upload.wikimedia.org/wikipedia/en/thumb/7/7c/Everton_FC_logo.svg/200px-Everton_FC_logo.svg.png",
 FUL:"https://upload.wikimedia.org/wikipedia/en/thumb/e/eb/Fulham_FC_%28shield%29.svg/200px-Fulham_FC_%28shield%29.svg.png",
 LIV:"https://upload.wikimedia.org/wikipedia/en/thumb/0/0c/Liverpool_FC.svg/200px-Liverpool_FC.svg.png",
 CTY:"https://upload.wikimedia.org/wikipedia/en/thumb/e/eb/Manchester_City_FC_badge.svg/200px-Manchester_City_FC_badge.svg.png",
 MAN:"https://upload.wikimedia.org/wikipedia/en/thumb/7/7a/Manchester_United_FC_crest.svg/200px-Manchester_United_FC_crest.svg.png",
 NWC:"https://upload.wikimedia.org/wikipedia/en/thumb/5/56/Newcastle_United_Logo.svg/200px-Newcastle_United_Logo.svg.png",
 NOT:"https://upload.wikimedia.org/wikipedia/en/thumb/e/e5/Nottingham_Forest_F.C._logo.svg/960px-Nottingham_Forest_F.C._logo.svg.png",
 TOT:"https://upload.wikimedia.org/wikipedia/en/thumb/b/b4/Tottenham_Hotspur.svg/200px-Tottenham_Hotspur.svg.png",
 WHA:"https://upload.wikimedia.org/wikipedia/en/thumb/c/c2/West_Ham_United_FC_logo.svg/200px-West_Ham_United_FC_logo.svg.png",
 WOL:"https://upload.wikimedia.org/wikipedia/en/thumb/f/fc/Wolverhampton_Wanderers.svg/200px-Wolverhampton_Wanderers.svg.png"
};

let currentUser = localStorage.getItem("jb_user");
let tableCache = null;
let chartDataCache = null;
let historyChart = null;
let currentBetData = {};

function checkLogin() {
  if(!currentUser) document.getElementById("loginOverlay").style.display = "flex";
  else { document.getElementById("loginOverlay").style.display = "none"; loadData(); }
}
function loginUser(name) { currentUser = name; localStorage.setItem("jb_user", name); document.getElementById("loginOverlay").style.display = "none"; loadData(); }
function logout() { localStorage.removeItem("jb_user"); location.reload(); }

function loadData() {
  fetch(API_URL).then(r=>r.json()).then(data => {
    tableCache = data.leagueTable;
    chartDataCache = data.chartData;
    renderApp(data);
  });
}

function renderApp(data) {
  const left = document.getElementById("left");
  const right = document.getElementById("right");
  const weekly = document.getElementById("weeklyCard");
  const ranking = document.getElementById("rankingBody");
  left.innerHTML = ""; right.innerHTML = ""; weekly.innerHTML = '<div style="font-weight:700;margin-bottom:8px;">Weekly Summary</div>'; ranking.innerHTML = "";

  // LEFT HEADER
  const lh = document.createElement("div"); lh.className = "left-header";
  lh.innerHTML = `<div class="pl-btn" onclick="openTable()"><img src="https://media.api-sports.io/football/leagues/39.png" class="pl-logo"></div><div class="header-title-box"><div class="header-main-text">JUICE BETS</div><div class="header-sub-text">${currentUser||"Guest"}</div></div><div class="brand-btn"><img src="apple-touch-icon.png" class="brand-logo"></div>`;
  left.appendChild(lh);
  left.appendChild(document.createElement("div")).className = "left-divider";

  // LOGIC: Check if ALL active columns have a price in Row 18.
  // data.betSummary[1] is the "WIN" row (Row 18 in sheet).
  let isRow18Full = false;
  if(data.betSummary && data.betSummary[1]) {
     // Check columns that are not "red" (active)
     const activeIndices = data.headers.map((h,i) => h.status !== 'red' ? i : -1).filter(i => i !== -1);
     const filledCount = activeIndices.filter(i => data.betSummary[1].cells[i] && data.betSummary[1].cells[i].value).length;
     // If we have some active columns and ALL of them have a value -> RANKING MODE
     if(activeIndices.length > 0 && filledCount >= activeIndices.length) isRow18Full = true;
  }

  // SORT INDICES
  let sortedIndices = data.headers.map((h, i) => ({ ...h, originalIndex: i }));
  if (!isRow18Full) {
    // FORCE FIXED ORDER if bets are not confirmed
    const order = ["Snackbar", "Timbo", "Pepe"];
    sortedIndices.sort((a, b) => {
       let idxA = order.indexOf(a.name);
       let idxB = order.indexOf(b.name);
       if(idxA === -1) idxA = 99; if(idxB === -1) idxB = 99;
       return idxA - idxB;
    });
  }

  // HEADER ROW
  const hRow = document.createElement("div"); hRow.className = "row header-row-sticky";
  sortedIndices.forEach(h => {
     const w = document.createElement("div"); w.className = "header-pill-wrapper";
     const p = document.createElement("div"); p.className = "header-pill";
     if(AVATARS[h.name]) p.innerHTML = `<img src="${AVATARS[h.name]}" class="avatar-img">`;
     else p.textContent = h.name;
     if(h.status==='orange') p.classList.add("status-orange");
     if(h.status==='red') p.classList.add("status-red");
     w.appendChild(p); hRow.appendChild(w);
  });
  right.appendChild(hRow);

  // MATCH ROWS
  data.matches.forEach((m, idx) => {
    // Left
    const lr = document.createElement("div"); lr.className = "left-row";
    lr.onclick = () => openModal(m); // Fix Match Stats Click
    const [h, a] = m.match.split("-");
    lr.innerHTML = `<div class="left-cell match"><div class="match-teams"><div class="team-wrap-rel">${renderTeam(h)}</div><span>-</span><div class="team-wrap-rel">${renderTeam(a)}</div></div></div><div class="left-cell" style="width:90px;">${m.status === 'NS' ? m.startTime : m.status + ' ' + (m.score||'')}</div>`;
    left.appendChild(lr);

    // Right
    const rr = document.createElement("div"); rr.className = "row";
    sortedIndices.forEach(h => {
       const cell = m.cells[h.originalIndex];
       const el = document.createElement("div"); el.className = "bet";
       el.textContent = cell.value;
       el.style.backgroundColor = cell.color;
       if(!cell.value) { el.classList.add("empty"); el.style.backgroundColor = "transparent"; }
       
       // EDIT LOGIC: Only if user matches name, column not red, and row 18 NOT filled for this specific column
       const isMyCol = h.name === currentUser;
       const isColLocked = h.status === 'red' || cell.color === '#ff4d4d';
       const priceRowFilled = (data.betSummary && data.betSummary[1] && data.betSummary[1].cells[h.originalIndex] && data.betSummary[1].cells[h.originalIndex].value);
       
       if(isMyCol && !isColLocked && !priceRowFilled && m.status === 'NS') {
          el.classList.add("editable-active");
          // FIX #4: Calculate SHEET COLUMN. API data starts at Col 3 (C).
          // headers array maps to API columns 0, 1, 2...
          // So Sheet Column = 3 (start offset) + h.originalIndex + 1 (1-based)
          // Wait, h.originalIndex is index in `headers` array.
          // In `buildDashboard` GAS, `colMaps` maps headers.
          // `colMaps[i].idx` is the raw column index from the spreadsheet (0-based from raw values).
          // We need to pass THAT.
          // Actually, let's just use the logic: Sheet Data starts at Col 1.
          // The API returns `headers` which has `h.originalIndex`. 
          // We must blindly trust `h.originalIndex` maps to the column order in `matches.cells`.
          // We need to send `h.originalIndex + 4` (A=1, B=2, C=3 (Start of data? No wait)).
          // Let's pass the 1-based column index derived from the backend.
          // The backend `buildDashboard` function knows the index.
          // I will assume the first data column is Column D (4).
          // But `colMaps` in GAS sorted them.
          // Let's just pass `h.originalIndex` + 4 (assuming A,B,C are metadata).
          // Better: pass `h.originalIndex` and let GAS map it if we knew the mapping.
          // Actually, simply: `3 + h.originalIndex + 1`. (D is 4).
          // Let's look at GAS: `for (let c = 3; c < rawHeaders.length; c++)`.
          // So first header is index 3 (Column D).
          // So Sheet Column = 3 + 1 = 4.
          // So Formula: `h.originalIndex + 4`.
          el.onclick = () => openBetInput(idx, h.originalIndex + 4, m.match, el);
       }
       rr.appendChild(el);
    });
    right.appendChild(rr);
  });

  // SUMMARY ROWS
  ["BET","WIN","WIN PP"].forEach((l, i) => {
    const lab = document.createElement("div"); lab.className = "left-label"; lab.textContent = l; left.appendChild(lab);
    const rr = document.createElement("div"); rr.className = "row";
    sortedIndices.forEach(h => {
       const c = data.betSummary[i].cells[h.originalIndex];
       const el = document.createElement("div"); el.className = "bet";
       el.textContent = "¬£"+(c.value||0);
       el.style.backgroundColor = c.color || "#2f343a";
       rr.appendChild(el);
    });
    right.appendChild(rr);
  });

  // TOTALS & RANKING
  data.totals.forEach(t => {
     weekly.innerHTML += `<div class="week-row"><div class="week-label">${t.label}</div><div class="week-gbp">¬£${t.cells[1].value}</div></div>`;
  });
  data.ranking.forEach((r, i) => {
     ranking.innerHTML += `<div class="rank-row"><div class="rank-pos">#${i+1}</div><div class="rank-name">${r.name}</div><div class="rank-money">¬£${r.money}</div></div>`;
  });
  
  // Click Ranking to open chart
  document.getElementById("rankingCard").onclick = () => {
      document.getElementById("historyModal").classList.add("active");
      drawHistoryChart();
  };
}

// BET INPUT
function openBetInput(rowIdx, sheetCol, title, el) {
  if(navigator.vibrate) navigator.vibrate(20);
  currentBetData = { row: rowIdx, col: sheetCol, el: el };
  document.getElementById("bmTitle").textContent = title;
  document.getElementById("customBetInput").value = "";
  document.getElementById("betModal").style.display = "flex";
  setTimeout(() => document.getElementById("betModal").classList.add("active"), 10);
}
function closeBetModal() {
  document.getElementById("betModal").classList.remove("active");
  setTimeout(() => document.getElementById("betModal").style.display = "none", 300);
}
function setBetValue(v) { submitBet(v); }
function submitCustomBet() { submitBet(document.getElementById("customBetInput").value); }
function submitBet(val) {
  closeBetModal();
  if(!val) return;
  const el = currentBetData.el;
  el.textContent = val;
  el.style.border = "2px solid #fff";
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ row: currentBetData.row, sheetCol: currentBetData.col, value: val })
  }).then(r=>r.json()).then(d => {
    if(d.status==="success") { el.style.border = "2px dashed var(--accent-orange)"; }
    else { alert("Error"); }
  });
}

// MODALS
function openTable() {
  const b = document.getElementById("tableBody");
  b.innerHTML = "";
  if(tableCache) {
     tableCache.forEach(t => {
       b.innerHTML += `<div class="tbl-row tbl-grid"><div class="ta-l">${t.rank}</div><div class="tbl-team-wrap"><img src="${t.logo}" class="tbl-logo"><span>${t.team}</span></div><div class="ta-c">${t.mp}</div><div class="ta-c txt-green">${t.pts}</div><div class="ta-c">${t.gd}</div><div class="ta-r">${t.form}</div></div>`;
     });
  } else { b.innerHTML = "<div style='padding:20px;text-align:center'>Loading...</div>"; }
  document.getElementById("tableModal").classList.add("active");
}

function openModal(m) {
  document.getElementById("matchModal").classList.add("active");
  document.getElementById("mTitle").textContent = m.match;
  document.getElementById("mStatus").textContent = m.status + " ‚Ä¢ " + (m.score||"0-0");
  
  // PARSE STATS
  let stats = m.stats || {};
  // If stats came as JSON string from GAS, parse it
  if(typeof stats.h_xg === 'undefined' && m.cells) {
     // Fallback if detailed stats are nested
  }
  
  // Render Stats
  const sa = document.getElementById("statsArea");
  let html = "";
  const props = [
      {l:"Possession", h:stats.h_poss, a:stats.a_poss, pct:true},
      {l:"Expected Goals (xG)", h:stats.h_xg, a:stats.a_xg},
      {l:"Shots", h:stats.h_shots_tot, a:stats.a_shots_tot},
      {l:"On Target", h:stats.h_shots, a:stats.a_shots},
      {l:"Corners", h:stats.h_corners, a:stats.a_corners}
  ];
  props.forEach(p => {
      let h = p.h||0, a = p.a||0;
      let hp = 50, ap = 50;
      if((h+a)>0) { hp = (h/(h+a))*100; ap = (a/(h+a))*100; }
      html += `<div class="stat-row"><div class="stat-label"><span>${h}${p.pct?'%':''}</span><span style="opacity:0.6">${p.l}</span><span>${a}${p.pct?'%':''}</span></div><div class="stat-bar-container"><div class="sb-half home"><div class="sb-fill" style="width:${hp}%"></div></div><div class="sb-half away"><div class="sb-fill" style="width:${ap}%"></div></div></div></div>`;
  });
  sa.innerHTML = html || "<div style='padding:20px;text-align:center'>No stats available</div>";
}

function drawHistoryChart() {
  if(!chartDataCache) return;
  const ctx = document.getElementById("historyChart").getContext("2d");
  if(historyChart) historyChart.destroy();
  
  const labels = chartDataCache.matches.map(m => new Date(m.date).toLocaleDateString());
  // Assuming money history
  const dataMoney = chartDataCache.money || [];
  
  historyChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: 'Snackbar', data: dataMoney.map(d=>d.Snackbar), borderColor: '#7CFF5B', tension: 0.3 },
        { label: 'Timbo', data: dataMoney.map(d=>d.Timbo), borderColor: '#4DA3FF', tension: 0.3 },
        { label: 'Pepe', data: dataMoney.map(d=>d.Pepe), borderColor: '#FF5BC4', tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { x: { display: false }, y: { grid: { color: 'rgba(255,255,255,0.1)' } } }
    }
  });
}

function closeModal(id) { document.getElementById(id).classList.remove("active"); }
function switchTab(t) {
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  document.getElementById("tab"+t.charAt(0).toUpperCase()+t.slice(1)).classList.add("active");
  ["stats","lineups","summary"].forEach(x => document.getElementById("view"+x.charAt(0).toUpperCase()+x.slice(1)).style.display = x===t?"block":"none");
}
function renderTeam(code) {
  code = code.trim();
  const logo = TEAM_LOGOS[code] || "";
  if(logo) return `<img src="${logo}" class="team-logo">`;
  return `<span style="font-weight:700">${code}</span>`;
}
document.getElementById("summaryToggle").onclick = () => { document.getElementById("summaryContentWrap").classList.toggle("hidden"); document.getElementById("summaryToggle").classList.toggle("open"); };

checkLogin();
setInterval(loadData, 30000);
Chart.register(ChartDataLabels);
</script>
</body>
</html>
