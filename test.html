<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="manifest" href="/bet-dashboard/manifest.json">
<meta name="theme-color" content="#134d2b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Juice Bets">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<title>Juice Bets v6.0 Login</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
/* --- CORE CSS --- */
:root{ --bg-main:#1c1f23; --bg-card:#262a30; --bg-soft:#2f343a; --bg-row:#343a40; --text-main:#ffffff; --text-muted:#9aa0a6; --accent-orange: #ff9f43; --accent-green: #7CFF5B; --row-h:50px; --header-h:50px; --header-pill-w:70px; --gap:8px; --left-w:230px; --bet-w:80px; --summary-w:200px; --week-row-h:30px; --filter-h: 40px; --rad-sm: 6px; --rad-md: 10px; --rad-lg: 14px; }
*{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
body{ margin:0; font-family:Inter,system-ui,sans-serif; background: radial-gradient(circle at 50% 0%, #2f343a 0%, #1c1f23 80%); color:var(--text-main); height: 100vh; overflow: hidden; letter-spacing: -0.02em; }

/* LAYOUT */
.app{ height:100vh; display:grid; grid-template-rows: 1fr auto; }
.main{ display:flex; gap:10px; padding:10px; overflow:hidden; position: relative; z-index: 5; }
.left-card{ width:var(--left-w); background:var(--bg-card); border-radius:var(--rad-lg); padding:8px; display:flex; flex-direction:column; gap:var(--gap); overflow-y:auto; max-height:100%; scrollbar-width:none; border: 1px solid rgba(255, 255, 255, 0.08); }
.left-card::-webkit-scrollbar { display: none; }
.right-card{ flex:1; background:var(--bg-card); border-radius:var(--rad-lg); overflow-x:auto; overflow-y:auto; padding:8px; scrollbar-width:none; border: 1px solid rgba(255, 255, 255, 0.08); }
.right-card::-webkit-scrollbar { display: none; }

/* HEADER & FILTERS */
.left-header { height:var(--header-h); background: rgba(47, 52, 58, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.05); border-radius:var(--rad-md); display:flex; align-items:center; justify-content:center; position: sticky; top: 0; z-index: 20; }
.header-title-box { display:flex; flex-direction:column; align-items:center; line-height:1.2; }
.header-main-text { font-size: 11px; font-weight: 800; letter-spacing: 0.5px; }
.header-sub-text { font-size: 9px; font-weight: 600; color: var(--accent-orange); text-transform: uppercase; }
.spacer-bar { display: flex; align-items: center; justify-content: space-between; height: var(--filter-h); margin: 8px 0; }
.filter-btn { background: var(--bg-soft); border: 1px solid rgba(255,255,255,0.05); color: var(--text-muted); font-size: 10px; font-weight: 700; padding: 4px 10px; border-radius: var(--rad-sm); transition: all 0.2s; }
.filter-btn.active { background: #fff; color: #000; }
.left-divider, .right-divider { height: 6px; flex-shrink: 0; }

/* MATCH ROWS */
.left-row{ height:var(--row-h); display:grid; grid-template-columns:1fr 90px; gap:var(--gap); cursor: pointer; position: relative; z-index: 5; border-radius: 12px; transition: transform 0.1s; }
.left-row:active { transform: scale(0.96); background: rgba(255,255,255,0.1); }
.left-cell{ background:var(--bg-soft); border-radius:var(--rad-md); display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:600; }
.match-teams { display: flex; align-items: center; gap: 6px; }
.team-logo { width: 30px; height: 30px; object-fit: contain; }

/* BET PILLS */
.rows{ display:flex; flex-direction:column; gap:var(--gap); min-width:max-content; }
.row{ display:flex; gap:var(--gap); }
.header-row-sticky { position: sticky; top: 0; z-index: 20; background: var(--bg-card); height: var(--header-h); display: flex; align-items: center; }
.header-pill-wrapper { width: var(--bet-w); height: 100%; display: flex; align-items: center; justify-content: center; }
.header-pill{ width:var(--header-pill-w); height:50px; background:var(--bg-soft); border-radius:var(--rad-md); display:flex; align-items:center; justify-content:center; font-size:16px; font-weight:800; position:relative; overflow: visible; }
.avatar-img { width: 100%; height: 100%; object-fit: contain; transform: scale(1.35); filter: drop-shadow(0 4px 5px rgba(0,0,0,0.4)); z-index: 5; }

.bet{ width:var(--bet-w); height:var(--row-h); border-radius: var(--rad-md); display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:800; color:#111; background: var(--bet-bg); box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s; }
.bet.empty { background: transparent !important; border: none !important; box-shadow: none !important; }

/* --- EDITABLE MODE STYLES --- */
.editable-col .header-pill { box-shadow: 0 0 0 2px var(--accent-orange); }
.editable-col .bet:not(.empty) { cursor: pointer; }
.editable-col .bet.editable-active { 
  border: 2px dashed var(--accent-orange) !important; 
  background-color: rgba(255, 159, 67, 0.1) !important;
  color: #fff !important;
}
.editable-col .bet.editable-active:active { transform: scale(0.9); background: var(--accent-orange) !important; color: #000 !important; }

/* --- LOGIN SCREEN --- */
.login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1c1f23; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
.login-title { font-size: 24px; font-weight: 800; margin-bottom: 40px; color: #fff; letter-spacing: -1px; }
.login-grid { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; max-width: 400px; }
.login-item { display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; transition: transform 0.2s; }
.login-item:active { transform: scale(0.9); }
.login-avatar { width: 90px; height: 90px; border-radius: 50%; background: #2f343a; border: 4px solid transparent; padding: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transition: all 0.3s; object-fit: contain; }
.login-item:hover .login-avatar { border-color: var(--accent-orange); transform: translateY(-5px); }
.login-name { font-weight: 700; font-size: 14px; color: var(--text-muted); }
.viewer-btn { margin-top: 50px; background: transparent; border: 1px solid rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 30px; color: #fff; font-weight: 600; cursor: pointer; }

/* --- BET INPUT MODAL --- */
.bet-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2500; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
.bet-card { background: var(--bg-card); padding: 25px; border-radius: 20px; width: 300px; display: flex; flex-direction: column; gap: 15px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); transform: translateY(20px); transition: transform 0.3s; }
.bet-modal.active .bet-card { transform: translateY(0); }
.bet-match-title { text-align: center; font-size: 14px; font-weight: 700; color: #fff; margin-bottom: 10px; }
.bet-options { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.opt-btn { background: var(--bg-soft); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 15px 0; border-radius: 12px; font-weight: 800; font-size: 18px; cursor: pointer; transition: background 0.2s; }
.opt-btn:active { background: var(--accent-orange); color: #000; }
.score-input-wrap { display: flex; gap: 10px; align-items: center; justify-content: center; margin-top: 5px; }
.score-in { background: #111; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 8px; width: 100%; text-align: center; font-size: 16px; font-weight: 700; }
.submit-bet-btn { background: var(--accent-green); color: #000; border: none; padding: 15px; border-radius: 12px; font-weight: 800; font-size: 14px; cursor: pointer; margin-top: 10px; width: 100%; }
.close-bet { position: absolute; top: 15px; right: 15px; color: #fff; cursor: pointer; font-size: 20px; opacity: 0.5; }

/* --- SUMMARY FOOTER --- */
.summary { background: var(--bg-card); margin: 0 10px 10px 10px; border-radius: var(--rad-lg); overflow: hidden; position: relative; z-index: 10; border: 1px solid rgba(255, 255, 255, 0.08); }
.summary-toggle{ background:var(--bg-soft); padding:8px 12px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.summary-toggle::before{ content:"▼"; font-size:14px; transition:transform .25s ease; }
.summary-toggle.open::before{ transform:rotate(180deg); }
.summary-content{ padding:10px; display:none; }
.summary-content.show{ display:block; }
.logout-btn { background: #ff4d4d; border: none; padding: 4px 12px; border-radius: 12px; color: #fff; font-size: 10px; font-weight: 700; margin-left: 10px; cursor: pointer; }

/* ANIMATIONS & OTHER UI */
@keyframes nervousPulse { 0% { transform: scale(1); } 50% { transform: scale(1.08); box-shadow: 0 0 15px var(--accent-orange); } 100% { transform: scale(1); } }
.status-orange { background-color: var(--accent-orange) !important; color: #000 !important; animation: nervousPulse 1.5s infinite ease-in-out !important; }
.status-green { background-color: var(--accent-green) !important; color: #000 !important; }
.status-red { background-color: #ff4d4d !important; color: #fff !important; opacity: 0.9; }
.gold-active { background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%) !important; animation: goldPulse 2s infinite !important; }

/* MOBILE ADJUSTMENTS */
@media (max-width: 768px){ .app { display: flex; flex-direction: column; overflow-y: auto; height: auto; min-height: 100vh; } .main { flex-direction: row; overflow: visible; } .left-card, .right-card { max-height: none; overflow: visible; } }
</style>
</head>
<body>

<div id="loginOverlay" class="login-overlay">
  <div class="login-title">Who are you?</div>
  <div class="login-grid">
    <div class="login-item" onclick="loginUser('Snackbar')">
      <img src="./snackbar.png" class="login-avatar">
      <div class="login-name">Snackbar</div>
    </div>
    <div class="login-item" onclick="loginUser('Timbo')">
      <img src="./timbo.png" class="login-avatar">
      <div class="login-name">Timbo</div>
    </div>
    <div class="login-item" onclick="loginUser('Pepe')">
      <img src="./pepe.png" class="login-avatar">
      <div class="login-name">Pepe</div>
    </div>
  </div>
  <button class="viewer-btn" onclick="loginUser('Viewer')">Just Watching</button>
</div>

<div id="betModal" class="bet-modal">
  <div class="bet-card">
    <div class="close-bet" onclick="closeBetModal()">×</div>
    <div class="bet-match-title" id="bmTitle">ARS vs MAN</div>
    <div class="bet-options">
      <button class="opt-btn" onclick="setBetValue('1')">1</button>
      <button class="opt-btn" onclick="setBetValue('X')">X</button>
      <button class="opt-btn" onclick="setBetValue('2')">2</button>
    </div>
    <div class="score-input-wrap">
      <input type="text" id="customBetInput" class="score-in" placeholder="Score (e.g. 2-1) or O1.5">
    </div>
    <button class="submit-bet-btn" onclick="submitCustomBet()">PLACE BET</button>
  </div>
</div>

<div class="app">
  <div class="main">
    <div class="left-card" id="left"></div>
    <div class="right-card"><div class="rows" id="right"></div></div>
  </div>

  <footer class="summary">
    <div class="summary-toggle" id="summaryToggle"></div>
    <div class="summary-content" id="summaryContentWrap">
       <div id="weeklyCard"></div>
       <button class="logout-btn" onclick="logout()">LOGOUT</button>
    </div>
  </footer>
</div>

<script>
// --- CONFIG ---
const API_URL="https://script.google.com/macros/s/AKfycbwyH6V8PAyglEdBCOyGgVRhrVLFVLhdr4deKPUznv8Rk2I9tz3plm4O0kfgfxkGdskwFw/exec";
const AVATARS = { "Snackbar": "./snackbar.png", "Timbo": "./timbo.png", "Pepe": "./pepe.png" };
let currentUser = localStorage.getItem("jb_user");
let currentBetData = { row: null, colHeader: null, match: null };

// --- LOGIN LOGIC ---
function checkLogin() {
  if(!currentUser) {
    document.getElementById("loginOverlay").style.display = "flex";
  } else {
    document.getElementById("loginOverlay").style.display = "none";
    loadData();
  }
}

function loginUser(name) {
  currentUser = name;
  localStorage.setItem("jb_user", name);
  document.getElementById("loginOverlay").style.opacity = "0";
  setTimeout(() => {
    document.getElementById("loginOverlay").style.display = "none";
    loadData();
  }, 500);
}

function logout() {
  localStorage.removeItem("jb_user");
  location.reload();
}

// --- DATA LOADING ---
function loadData(){
  fetch(API_URL).then(r=>r.json()).then(data=>{
    renderApp(data);
  }).catch(e => console.error(e));
}

function renderApp(data) {
  const left=document.getElementById("left"), right=document.getElementById("right");
  left.innerHTML=""; right.innerHTML=""; 

  // CHECK IF BETS ARE LOCKED (Any price in summary row 18 > 0)
  // We check the first column of each person. 
  // For simplicity: If ANY column has a price in the summary, we consider the "Game ON" mode
  // But strictly per user: Locking is usually per column.
  
  // SORTING LOGIC:
  // Requirement: Fixed order (Snackbar, Timbo, Pepe) UNTIL confirmed.
  // We will re-order the `data.headers` and `matches.cells` arrays before rendering.
  
  // 1. Detect if locking phase is active (Check Summary Row 18 aka index 1 in betSummary)
  let isGlobalLock = false;
  if(data.betSummary && data.betSummary[1]) {
     // If any cell in row 18 has a value, we assume the game has started/bets locked
     isGlobalLock = data.betSummary[1].cells.some(c => c.value && c.value > 0);
  }

  // 2. Sort Indices
  let sortedIndices = data.headers.map((h, i) => ({ ...h, originalIndex: i }));
  
  if (!isGlobalLock) {
    // FORCE FIXED ORDER: Snackbar, Timbo, Pepe
    const order = ["Snackbar", "Timbo", "Pepe"];
    sortedIndices.sort((a, b) => {
       let idxA = order.indexOf(a.name);
       let idxB = order.indexOf(b.name);
       if(idxA === -1) idxA = 99; // Extra columns go to end
       if(idxB === -1) idxB = 99;
       return idxA - idxB;
    });
  } 
  // If isGlobalLock is true, we use the order sent by API (which follows the sheet order or ranking)

  // RENDER HEADER
  const lh=document.createElement("div"); lh.className="left-header"; 
  lh.innerHTML=`<div class="header-title-box"><span class="header-main-text">JUICE BETS</span><span class="header-sub-text">${currentUser || 'Guest'}</span></div>`;
  left.appendChild(lh);
  
  const headerRow = document.createElement("div"); headerRow.className="row header-row-sticky";
  
  sortedIndices.forEach(h => {
    const wrapper = document.createElement("div"); wrapper.className = "header-pill-wrapper";
    const p = document.createElement("div"); p.className="header-pill";
    
    // Avatar Logic
    if(AVATARS[h.name]) p.innerHTML = `<img src="${AVATARS[h.name]}" class="avatar-img">`;
    else p.textContent = h.name;

    // Status Colors
    if(h.status === 'orange') p.classList.add('status-orange');
    if(h.status === 'red') p.classList.add('status-red');
    if(h.name === currentUser) wrapper.classList.add('editable-col'); // Marker for CSS

    wrapper.appendChild(p);
    headerRow.appendChild(wrapper);
  });
  right.appendChild(headerRow);

  // RENDER MATCHES
  data.matches.forEach((m, rowIdx) => {
     // LEFT SIDE (Match Info)
     const lr = document.createElement("div"); lr.className="left-row";
     const [hTeam, aTeam] = m.match.split("-");
     const isLive = m.status.includes("'") || m.status === "HT";
     lr.innerHTML = `<div class="left-cell"><div class="match-teams"><span>${hTeam}</span><span style="font-size:10px;opacity:0.6">vs</span><span>${aTeam}</span></div></div><div class="left-cell" style="width:90px;color:${isLive?'#7CFF5B':'#fff'}">${isLive ? m.status + ' ' + m.score : m.startTime || m.status}</div>`;
     left.appendChild(lr);

     // RIGHT SIDE (Bets)
     const rr = document.createElement("div"); rr.className="row";
     
     sortedIndices.forEach((h) => {
        const cell = m.cells[h.originalIndex]; // Get data using original index
        const el = document.createElement("div");
        el.className = "bet";
        el.textContent = cell.value;
        el.style.backgroundColor = cell.color;
        
        if(!cell.value) {
           el.classList.add("empty");
           el.style.backgroundColor = "transparent";
        }

        // EDITABLE LOGIC
        // 1. Must be logged in as this user
        // 2. Column must NOT be locked (status red or row 18 filled)
        // 3. Game must not be Live/Finished (simple check on m.status)
        const isMyCol = h.name === currentUser;
        const isColumnLocked = (h.status === 'red' || cell.color === '#ff4d4d' || cell.color === '#ea9999'); 
        const isGameStarted = m.status !== 'NS';

        if(isMyCol && !isColumnLocked && !isGameStarted) {
           el.classList.add("editable-active");
           el.onclick = () => openBetInput(rowIdx, h.name, m.match, el);
        }

        rr.appendChild(el);
     });
     right.appendChild(rr);
  });

  // SUMMARY SECTION (Simple Render)
  const weekly = document.getElementById("weeklyCard");
  weekly.innerHTML = `<div style="padding:10px;font-weight:700">Weekly Summary</div>`;
  if(data.totals) {
     data.totals.forEach(t => {
       weekly.innerHTML += `<div style="display:flex;justify-content:space-between;padding:4px 10px;font-size:12px;"><span>${t.label}</span><span style="color:#7CFF5B">£${t.cells[1].value}</span></div>`;
     });
  }
}

// --- BET INPUT FUNCTIONS ---
function openBetInput(rowIdx, colHeader, matchName, el) {
  // Use Vibrate API for feedback
  if(navigator.vibrate) navigator.vibrate(20);
  
  currentBetData = { row: rowIdx, header: colHeader, match: matchName, element: el };
  document.getElementById("bmTitle").textContent = matchName;
  document.getElementById("customBetInput").value = "";
  document.getElementById("betModal").style.display = "flex";
  setTimeout(()=> document.getElementById("betModal").classList.add("active"), 10);
}

function closeBetModal() {
  document.getElementById("betModal").classList.remove("active");
  setTimeout(()=> document.getElementById("betModal").style.display = "none", 300);
}

function setBetValue(val) {
  submitBet(val);
}

function submitCustomBet() {
  const val = document.getElementById("customBetInput").value;
  if(val) submitBet(val);
}

function submitBet(val) {
  closeBetModal();
  
  // 1. OPTIMISTIC UI UPDATE
  const el = currentBetData.element;
  const prevText = el.textContent;
  const prevBg = el.style.backgroundColor;
  
  el.textContent = val;
  el.classList.remove("empty");
  el.style.backgroundColor = "#2f343a"; // Temporary 'pending' color
  el.style.border = "2px solid #fff";

  // 2. SEND TO SERVER
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      user: currentUser,
      header: currentBetData.header,
      row: currentBetData.row,
      value: val
    })
  })
  .then(r => r.json())
  .then(resp => {
    if(resp.status === "success") {
       // Success feedback
       el.style.borderColor = "var(--accent-orange)";
       el.style.borderStyle = "dashed";
       // Trigger confetti if it's a new bet
       if(!prevText) confetti({ particleCount: 30, spread: 50, origin: { y: 0.6 } });
    } else {
       // Revert on error
       alert("Error saving bet: " + resp.message);
       el.textContent = prevText;
       el.style.backgroundColor = prevBg;
    }
  })
  .catch(err => {
     alert("Connection Error");
     el.textContent = prevText;
  });
}

// TOGGLE FOOTER
document.getElementById("summaryToggle").onclick = () => {
  document.getElementById("summaryContentWrap").classList.toggle("show");
  document.getElementById("summaryToggle").classList.toggle("open");
};

// INIT
checkLogin();
// Auto refresh every 30s
setInterval(loadData, 30000);

</script>
</body>
</html>
